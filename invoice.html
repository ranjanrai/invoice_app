<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Invoice Generator — Mobile Friendly (Updated)</title>

  <style>
    :root{--muted:#6b7280;--accent:#0b5ed7;--bg:#f3f4f6}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:14px;color:#111;-webkit-font-smoothing:antialiased}
    .app{max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px;font-size:18px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .controls button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px}
    .controls .primary{background:#0b5ed7}
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px;width:100%;font-size:14px}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .table-wrap{overflow:auto;border-radius:8px;background:#fff;padding:8px;border:1px solid #e6e6e6}
    .lines-table{width:100%;border-collapse:collapse;font-size:13px;min-width:900px}
    .lines-table th,.lines-table td{border:1px solid #111;padding:8px}
    .lines-table th{background:#fff;font-weight:700}
    .summary{max-width:360px;margin-left:auto;border-left:0}
    .summary .row-item{display:flex;justify-content:space-between;padding:6px 0}
    .summary .total{font-weight:700;font-size:18px}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:flex-start;justify-content:center;padding:20px;z-index:40}
    .modal-content{background:#fff;padding:18px;border-radius:10px;width:100%;max-width:980px;max-height:90vh;overflow:auto}
    .hidden{display:none}
    .products-table{width:100%;border-collapse:collapse;margin-top:8px}
    .products-table th,.products-table td{border:1px solid #ddd;padding:6px}

    .invoice-print{width:842px;min-height:1191px;background:#fff;padding:28px;font-size:12.5px;color:#111; position:relative}

    .inv-head-grid{display:grid;grid-template-columns: 1fr 1fr 1fr;align-items:center;gap:12px;margin-bottom:14px}
    .inv-head-left .lbl{ color:var(--muted); font-size:11px; }
    .inv-head-left .val{ font-size:16px; font-weight:800; letter-spacing:0.4px; margin-top:2px; }
    .inv-head-center { text-align:center; }
    .inv-head-right { text-align:right; }
    .inv-title { font-weight:900; font-size:22px; letter-spacing:0.5px; }
    .patient-pill{ display:inline-block; padding:2px 6px; border:1px solid #000; border-radius:3px; min-width:140px; }

    .lines-table-print{width:100%;border-collapse:collapse;border:2px solid #000;font-size:12px}
    .lines-table-print th,.lines-table-print td{border:2px solid #000;padding:6px}

    .totals-table{width:320px;border-collapse:collapse}
    .totals-table td{padding:4px}
    .totals-table .label{width:60%}

    .preview-controls{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .preview-wrapper{overflow:auto;border:1px solid #e6e6e6;padding:10px;background:#fafafa;display:flex;justify-content:center}
    .preview-scaler{transition:transform .18s ease;transform-origin:top left;}
    .preview-mode-mobile .preview-scaler{transform:scale(0.45);}
    .preview-mode-desktop .preview-scaler{transform:scale(1);}

    .action-btn{border-radius:6px;padding:6px 8px;border:1px solid #ddd;background:#fff;cursor:pointer;margin-left:4px}
    .action-btn.small{padding:4px 8px;font-weight:700}

    .customer-row{display:flex;gap:8px;align-items:center}
    .customer-select{flex:1}

    .preview-company {
      position:absolute; left:28px; bottom:28px; max-width:48%;
      background:rgba(255,255,255,0); padding:4px 0; line-height:1.3; color:#111; font-size:13px;
    }

    .preview-totals {
      position: static;
      display: block;
      margin-top: 8px;
      margin-left: auto;
      width: 340px;
      max-width: 90%;
      text-align: right;
      box-sizing: border-box;
    }
    .preview-totals .totals-table { margin:0; width:100%; border-collapse:collapse; }

    @media (max-width:900px){
      .row{grid-template-columns:repeat(2,1fr)}
      .controls{flex-direction:column}
      .controls button{width:100%}
      .lines-table{min-width:700px}
      .modal-content{height:100vh;max-width:100%;border-radius:0;padding:12px}
      .invoice-print{width:100%;min-height:auto;padding:18px}
      .summary{max-width:100%;margin-left:0}
      .inv-header{flex-direction:row}
    }

    /* Put History above other modals if both are open */
    #historyModal { z-index: 60; }

    @media (max-width:600px){
      h1{font-size:16px}
      .inv-header{flex-direction:column;align-items:flex-start;gap:8px}
      .inv-right{width:100%;text-align:left}
      .inv-center{order:2}
      .big-inv{font-size:16px}
      .lines-table{min-width:600px}
      .row{grid-template-columns:1fr}
      .preview-totals{ width:290px; max-width:100%; margin-left:auto; margin-right:0; }
    }

    .hq-indicator{font-size:12px;color:#0b5ed7;margin-left:8px;font-weight:700}

    .products-cell { white-space: normal; max-width: 520px; }
    .products-wrap { max-height: 160px; overflow: auto; }
    .mini-table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; }
    .mini-table th, .mini-table td { border: 1px solid #e5e7eb; padding: 4px 6px; vertical-align: top; }
    .mini-table th { background: #f9fafb; position: sticky; top: 0; z-index: 1; }
    .mini-table .t-right { text-align: right; }
    .mini-table .desc { white-space: normal; word-break: break-word; min-width: 220px; }
    
    /* Make bottom space so footer never gets cut in PDF */
.invoice-print {
  padding-bottom: 140px;
  position: relative;
}

/* Pin the footer block at the very bottom */
.footer-block {
  position: absolute;
  left: 20px;
  right: 0;
  bottom: 20px;
}

.footer-separator {
  border: none;
  border-top: 1px solid #999;
  margin: 18px 0;
}


/* === PRINT FIX FOR TEXT EXPORT === */
@media print {
  html, body {
    background: #fff !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    margin: 0;
    padding: 0;
  }

  #previewArea {
    transform: none !important;
    width: 842px !important;
    min-height: 1191px !important; /* A4 size */
    box-shadow: none !important;
    border: none !important;
    margin: 0 auto !important;
    background: #fff !important;
  }

  .preview-wrapper, .preview-scaler {
    transform: none !important;
    scale: 1 !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  .modal-content {
    border: none !important;
    box-shadow: none !important;
  }

  /* Hide UI buttons during print */
  #exportPdfBtn, #closePreviewBtn,
  .preview-controls, .controls {
    display: none !important;
  }

  /* Ensure all fonts render as on screen */
  * {
    color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
  }

  @page {
    size: A4;
    margin: 10mm;
  }
}

/* === Preview Buttons Styling === */
.preview-controls button {
  padding: 8px 14px;
  margin: 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

button.primary {
  background-color: #007bff;
  color: white;
}

button.secondary {
  background-color: #4caf50;
  color: white;
}

button.danger {
  background-color: #dc3545;
  color: white;
}

/* ✅ Hide buttons when printing or exporting */
@media print {
  .preview-controls,
  #exportPdfBtn,
  #closePreviewBtn,
  #printPreviewBtn {
    display: none !important;
  }
}

.preview-controls button {
  padding: 8px 14px;
  margin: 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

button.primary {
  background-color: #007bff;
  color: white;
}

button.secondary {
  background-color: #4caf50;
  color: white;
}

button.danger {
  background-color: #dc3545;
  color: white;
}

/* Hide buttons during PDF/Print output */
@media print {
  .preview-controls,
  #exportPdfBtn,
  #printSnapshotBtn,
  #closePreviewBtn {
    display: none !important;
  }
}

  </style>
</head>
<body>

  <!-- AUTH CHECK (runs before UI renders) -->
  <script>
    (function(){
      try {
        const user = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
        if(!user){
          const current = (window.location.pathname.split('/').pop() || 'invoice.html');
          window.location.href = 'login.html?next=' + encodeURIComponent(current);
        } else {
          window.__LOGGED_IN_USER = user;
        }
      } catch(e){
        window.location.href = 'login.html';
      }
    })();
  </script>

  <div class="app">
    <h1>Invoice Generator — Mobile Friendly (Made by Ranjan Ray)</h1>

    <div class="controls">
      <button id="addLineBtn" class="primary">Add Line (+)</button>
      <button id="openSettingsBtn">Settings</button>
      <button id="previewBtn">Preview</button>
      <button id="saveBtn">Save (Offline)</button>

      <!-- FS API helpers -->
      <button id="openDbFileBtn" class="secondary">Open DB File</button>
      <button id="saveDbFileBtn" class="secondary">Save to DB File</button>

      <button id="exportDataBtn">Export Data (JSON)</button>
      <button id="importDataBtn">Import Data (JSON)</button>
      <input id="importFile" type="file" accept="application/json" class="hidden" />

      <button id="historyBtn" style="background:#111;color:#fff">History</button>
      <button id="logoutBtn" style="background:#fff;border:1px solid #ddd;color:#0b5ed7">Logout</button>
    </div>

    <!-- Top row -->
    <div class="row">
      <div>
        <label>Invoice Number</label>
        <input id="invoiceNo" readonly />
      </div>
      <div>
        <label>Issue Date</label>
        <input id="issueDate" type="date" />
      </div>
      <div>
        <label style="font-weight:700; font-size:14px; margin-bottom:6px; display:block">Customer / Bill To</label>
        <div class="customer-row">
          <select id="customerSelect" class="customer-select"></select>
          <button id="addCustomerBtn" class="action-btn small">+</button>
          <button id="manageCustomersBtn" class="action-btn small">Manage</button>
        </div>
        <textarea id="customerName" placeholder="Customer name / address (multiline supported)" rows="3" style="margin-top:8px;padding:10px;border:1px solid #ddd;border-radius:6px;width:100%;font-family:inherit;font-size:14px;line-height:1.2;resize:vertical"></textarea>
      </div>
      <div>
        <label style="font-weight:700; font-size:14px; margin-bottom:6px; display:block">Patient Name</label>
        <textarea id="patientName" placeholder="Enter Patient Name" rows="2" style="padding:10px;border:1px solid #ddd;border-radius:6px;width:100%;font-family:inherit;font-size:14px;line-height:1.2;resize:none;overflow:hidden"></textarea>
      </div>
    </div>

    <div class="table-wrap">
      <table class="lines-table" id="linesTable">
        <thead>
          <tr>
            <th style="width:40px">Sl. No.</th>
            <th>Product Description</th>
            <th style="width:100px">Size</th>
            <th style="width:110px">Rate</th>
            <th style="width:90px">Quantity</th>
            <th style="width:110px">Amount</th>
            <th style="width:80px">Action</th>
          </tr>
        </thead>
        <tbody id="linesBody"></tbody>
      </table>
    </div>

    <div style="display:flex;gap:12px;margin-top:12px;align-items:flex-start;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <div id="companyName" style="font-weight:700;margin-bottom:6px">M/s BONE CARE SURGICALS</div>
        <div id="companyReg">18CXXPS2640JIZN</div>
        <div id="companyAddress">Rupnagar, Kamrup Metropolitan, Assam, 781032</div>
        <div id="companyEmail">bonecares@gmail.com</div>
        <div class="bank-info" style="margin-top:8px">
          <div>A/C: <span id="bankAcc">XXXXXX</span></div>
          <div>IFSC: <span id="bankIfsc">IDIB0000XXX</span></div>
          <div>BANK: <span id="bankName">INDIAN BANK</span> | BRANCH: <span id="bankBranch">GUWAHATI</span></div>
        </div>
      </div>

      <div class="summary" id="summaryBox" style="min-width:220px">
        <div class="row-item"><span>Sub Total</span><span id="subTotal">0.00</span></div>
        <div class="row-item"><span>Spl Discount (-)</span><span id="splDiscount">0.00</span></div>
        <div class="row-item"><span>P & F Charges</span><span id="pfCharges">0.00</span></div>
        <div class="row-item"><span>GST @ <span id="gstPercentTxt">5</span>%</span><span id="gstAmount">0.00</span></div>
        <hr />
        <div class="row-item total"><span>Total</span><span id="totalAmount">0.00</span></div>
      </div>
    </div>

    <!-- Settings modal -->
    <div id="settingsModal" class="modal hidden">
      <div class="modal-content">
        <h3>Settings</h3>

        <h4>Company Details</h4>
        <div class="row">
          <div><label>Company Name</label><input id="companyNameInput" /></div>
          <div><label>Registration/ GST / PAN</label><input id="companyRegInput" /></div>
          <div>
            <label>Logo (URL or upload)</label>
            <input id="logoUrl" placeholder="logo.png or https://..." />
            <input id="logoFile" type="file" accept="image/*" />
            <div style="font-size:12px;color:#666;margin-top:6px">Upload a high-resolution logo (PNG/JPEG). If very large, it will be downscaled a bit to stay stable.</div>
          </div>
        </div>

        <div class="row" style="align-items:center">
          <div style="display:flex;align-items:center;gap:8px">
            <input id="showLogo" type="checkbox" />
            <label for="showLogo" style="margin:0">Show logo in invoice preview / PDF</label>
          </div>
          <div><label>Logo width (px)</label><input id="logoWidth" type="number" min="40" max="1200" placeholder="120" /></div>
          <div></div>
        </div>

        <div class="row">
          <div><label>Address</label><textarea id="companyAddressInput" rows="2"></textarea></div>
          <div><label>Email</label><input id="companyEmailInput" /></div>
          <div>
            <label>Bank Account</label><input id="bankAccInput" placeholder="Account number" />
            <label style="margin-top:6px">IFSC</label><input id="bankIfscInput" placeholder="IFSC code" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:140px"><label>Bank Name</label><input id="bankNameInput" /></div>
          <div style="flex:1;min-width:140px"><label>Bank Branch</label><input id="bankBranchInput" /></div>
          <div style="flex:1;min-width:120px"><label>GST Percent</label><input id="gstPercent" type="number" value="5" /></div>
        </div>

        <div class="row" style="align-items:center;gap:8px;margin-top:12px">
          <div><label>Invoice Prefix</label><input id="invoicePrefix" placeholder="INV-2025-" /></div>
          <div><label>Invoice Seq (numeric)</label><input id="invoiceSeq" type="number" min="1" /></div>
          <div style="display:flex;align-items:flex-end;gap:8px"><button id="applyInvoiceNumberBtn">Apply Invoice Number</button></div>
        </div>
        <div style="font-size:12px;color:#666;margin-top:6px">
          Apply sets the visible invoice number. The sequence advances only when you export a PDF.
        </div>

        <hr style="margin:12px 0" />

        <h4>Customers</h4>
        <div style="display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1;min-width:260px">
            <label style="display:block;margin-bottom:6px;font-size:12px;color:var(--muted)">Add / Edit Customer (multiline allowed)</label>
            <textarea id="custName" rows="3" style="width:100%"></textarea>
            <div style="margin-top:8px"><button id="saveCustomerBtn">Save Customer</button></div>
          </div>
          <div style="flex:1;min-width:260px;overflow:auto;max-height:240px">
            <table class="products-table" id="customersTable">
              <thead><tr><th>#</th><th>Name</th><th>Action</th></tr></thead>
              <tbody id="customersBody"></tbody>
            </table>
          </div>
        </div>

        <hr style="margin:12px 0" />

        <h4>Products</h4>
        <div style="display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1;min-width:160px"><label>Description</label><textarea id="prodDesc" rows="2"></textarea></div>
          <div style="width:120px;min-width:120px"><label>Size</label><input id="prodSize" /></div>
          <div style="width:120px;min-width:120px"><label>Rate</label><input id="prodRate" type="number" /></div>
          <div style="display:flex;align-items:flex-end"><button id="addProdBtn">Add Product</button></div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table class="products-table" id="productsTable">
            <thead><tr><th>#</th><th>Description</th><th>Size</th><th>Rate</th><th>Action</th></tr></thead>
            <tbody id="productsBody"></tbody>
          </table>
        </div>

        <hr style="margin:12px 0" />

        <h4>Application Login</h4>
        <div class="row" style="align-items:center">
          <div><label>Username</label><input id="authUsername" placeholder="admin" /></div>
          <div><label>Password</label><input id="authPassword" type="password" placeholder="admin123" /></div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button id="saveAuthBtn">Add User</button>
            <button id="resetAuthBtn" class="action-btn small">Reset to default</button>
          </div>
        </div>
        <div style="margin-top:12px">
          <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Existing users</div>
          <table class="products-table" id="usersTable">
            <thead><tr><th>#</th><th>Username</th><th>Action</th></tr></thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>

        <div class="row">
          <div><label>Discount Type</label><select id="discountType"><option value="percent">Percent</option><option value="amount">Flat</option></select></div>
          <div><label>Discount Value</label><input id="discountValue" type="number" /></div>
          <div><label>P & F Charges</label><input id="pfValue" type="number" /></div>
        </div>

        <hr style="margin:12px 0" />

        <h4>PDF Export & Compression</h4>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="flex:1;min-width:180px">
            <label>PDF Quality</label>
            <input id="pdfQuality" type="range" min="0.1" max="1" step="0.05" value="0.8" />
            <div style="font-size:12px;color:#666;margin-top:6px">Lower = smaller file. Try 0.6–0.8.</div>
          </div>
          <div style="min-width:180px"><label>Compress images as JPEG</label><input id="compressJpeg" type="checkbox" /> Use JPEG</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:8px">
            <input id="highQualityPdf" type="checkbox" />
            <label for="highQualityPdf" style="margin:0">High Quality PDF (lossless)</label>
            <span id="hqIndicatorPreview" class="hq-indicator hidden">HQ ON</span>
          </div>
          <div><button id="toggleHighQualityBtn" class="action-btn small">Enable High Quality</button></div>
          <div style="font-size:12px;color:#666;flex:1">High-quality uses higher capture scale + PNG (bigger files) for crisper prints.</div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px">
          <label style="display:flex;align-items:center;gap:8px;">
            <input id="fastExport" type="checkbox" />
            Enable Fast Export (low render scale)
          </label>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px">
          <label style="display:flex;align-items:center;gap:8px;">
            <input id="exportTextLikePreview" type="checkbox" />
            Export as Text (Browser Print — matches Preview)
          </label>
          <div style="font-size:12px;color:#666">
            Creates a selectable-text PDF using your browser’s print dialog. Layout matches the on-screen preview.
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button id="saveSettings">Save</button>
          <button id="closeSettings">Close</button>
        </div>
      </div>
    </div>
    <!-- Settings modal END -->

    <!-- Preview / Printable Modal -->
    <div id="previewModal" class="modal hidden">
      <div class="modal-content">
        <div class="preview-controls">
          <label style="margin-right:6px;font-weight:700">Preview Mode:</label>
          <label><input type="radio" name="previewMode" value="desktop" checked /> Desktop</label>
          <label><input type="radio" name="previewMode" value="mobile" style="margin-left:8px" /> Mobile-fit (small)</label>
          <div style="margin-left:auto;font-size:12px;color:#666">Mobile-fit shows the desktop layout scaled down and exports a smaller visual PDF.</div>
        </div>

        <div class="preview-wrapper preview-mode-desktop" id="previewWrapper">
          <div class="preview-scaler" id="previewScaler">

            <div id="previewArea" class="invoice-print">
              

           <div class="inv-head-grid">
  <!-- Left: Invoice number + Bill To -->
  <div class="inv-head-left">
    <div class="lbl">INVOICE NUMBER</div>
    <div class="val" id="printInvoiceNo">INV-2025-00015</div>

    <!-- BILL TO directly below -->
    <div style="margin-top:4px;">
      <div class="lbl" style="font-weight:700;font-size:14px;margin-bottom:4px;  color:#000;">BILL TO</div>
      <div id="billToBox"
           style="padding:4px 0;
                  font-size:13px;
                  line-height:1.35;
                  width:240px;          /* ✅ Fixed width */
                  min-height:50px;
                  overflow:hidden;
                  word-break:break-word;
                  white-space:pre-line;">
      </div>
    </div>
  </div>

  <!-- Center: Logo -->
  <div class="inv-head-center">
    <img id="printLogoCenter" src="" alt="logo"
         style="max-width:140px;height:auto;display:block;margin:auto;" />
  </div>

  <!-- Right: Title + Issue date + Patient -->
  <div class="inv-head-right">
    <div class="inv-title">INVOICE</div>

    <div class="lbl" style="margin-top:6px;">ISSUE DATE</div>
    <div id="printDate" style="font-weight:700;">2025-11-10</div>

    <div class="lbl" style="margin-top:10px;">PATIENT NAME</div>
    <div id="printPatientNameBox"
         style="padding:4px 0;
                font-weight:700;
                font-size:12px;
                line-height:1.25;
                white-space:pre-line;
                display:inline-block;
                width:240px;           /* ✅ Same fixed width */
                min-height:20px;
                overflow:hidden;
                word-break:break-word;
                vertical-align:middle;
                transition:height 0.25s ease;">
    </div>
  </div>
</div>



              <div class="table-wrap-print">
                <table class="lines-table-print" id="printLines">
                  <thead>
                    <tr>
                      <th style="width:40px">Sl. No.</th>
                      <th>Product Description</th>
                      <th style="width:100px">Size</th>
                      <th style="width:110px">Rate</th>
                      <th style="width:90px">Quantity</th>
                      <th style="width:110px">Amount</th>
                    </tr>
                  </thead>
                  <tbody id="printLinesBody"></tbody>
                </table>
              </div>

          
<div class="footer-block" style="margin-top:12px">
  <div class="footer-cols" style="display:flex;flex-direction:column;gap:14px">

    <!-- HR line -->
    <hr style="border:0;border-top:1px solid #666;margin:0;">

    <!-- Existing 2-column layout -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:24px">

      <div class="company-col" style="width:60%">
        <div id="printCompanyName" class="c-name" style="font-weight:800;margin-bottom:6px">M/s BONE CARE SURGICALS</div>
        <div id="printCompanyReg" class="c-line">18CXXPS2640JIZN</div>
        <div id="printCompanyAddr" class="c-line">Rupnagar, Kamrup Metropolitan, Assam, 781032</div>
        <div id="printCompanyEmail" class="c-line">bonecares@gmail.com</div>
        <div class="c-line">
          A/C: <span id="printBankAcc"></span>
          &nbsp;&nbsp; IFSC: <span id="printBankIfsc"></span>
        </div>
      </div>

      <div class="totals-col" style="width:36%">
        <table class="totals-table">
          <tr><td>Sub Total</td><td id="pSubTotal" class="t-right">0.00</td></tr>
          <tr><td>Spl Discount (-)</td><td id="pDiscount" class="t-right">0.00</td></tr>
          <tr><td>P & F Charges</td><td id="pPF" class="t-right">0.00</td></tr>
          <tr><td>GST @ <span id="pGSTPercent">5</span>%</td><td id="pGST" class="t-right">0.00</td></tr>
          <tr class="grand"><td>Total</td><td id="pTotal" class="t-right">0.00</td></tr>
        </table>
      </div>

    </div>
  </div>
</div>

              <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
                <button id="exportPdfBtn">Export to PDF</button>
 
                <button id="closePreviewBtn">Close</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- History modal -->
    <div id="historyModal" class="modal hidden">
      <div class="modal-content">
        <h3>Invoice History</h3>
        <table class="products-table" style="margin-top:10px">
          <thead>
            <tr>
              <th>#</th>
              <th>Invoice No</th>
              <th>Date</th>
              <th>Bill To</th>
              <th>Patient Name</th>
              <th>Products</th>
              <th>Items</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="exportAllCsvBtn" style="background:#0b5ed7;color:#fff">Export All (CSV)</button>
          </div>
          <div style="text-align:right">
            <button id="closeHistoryBtn">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

  <script>
    // ================= DB & FS API =================
    const db = new Dexie('InvoiceDB');
    db.version(1).stores({ products:'id,name,size,rate,description', settings:'key', invoices:'++id,invoiceNumber,createdAt' });
    try { db.version(2).stores({ customers:'id,name' }); } catch(e){}
    try { db.version(3).stores({ users:'++id,username' }); } catch(e){}

    let persistedFileHandle = null;

    async function sha256hex(text){
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function pickDatabaseFile(){
      if(!window.showOpenFilePicker){
        alert('File System Access API not available. Use Export/Import instead.');
        document.getElementById('importFile').click();
        return;
      }
      try{
        const [handle] = await window.showOpenFilePicker({
          multiple:false,
          types:[{ description:'JSON', accept:{ 'application/json':['.json'] } }],
          excludeAcceptAllOption:false
        });
        persistedFileHandle = handle;
        const file = await handle.getFile();
        const text = await file.text();
        const obj = JSON.parse(text);
        await importDataFromObject(obj);
        alert('Database file opened and imported from disk.');
      }catch(err){ if(err?.name!=='AbortError') console.warn(err); }
    }

    async function writeToDatabaseFile(){
      if(!persistedFileHandle){ alert('No database file opened. Click "Open DB File" first.'); return; }
      try{
        const snapshot = await createDbSnapshot();
        const writable = await persistedFileHandle.createWritable();
        await writable.write(JSON.stringify(snapshot, null, 2));
        await writable.close();
        alert('Saved DB to opened file.');
      }catch(err){ console.error(err); alert('Save failed: ' + (err.message||err)); }
    }

    async function tryAutoSaveToHandle(){ if(!persistedFileHandle) return; try{ await writeToDatabaseFile(); }catch(e){ console.warn('autosave failed', e); } }

    async function createDbSnapshot(){
      const [productsArr, settingsArr, invoicesArr, customersArr, usersArr] = await Promise.all([
        db.products.toArray().catch(()=>[]),
        db.settings.toArray().catch(()=>[]),
        db.invoices.toArray().catch(()=>[]),
        (db.customers ? db.customers.toArray().catch(()=>[]) : Promise.resolve([])),
        (db.users ? db.users.toArray().catch(()=>[]) : Promise.resolve([]))
      ]);
      const seq = (await db.settings.get('invoice_seq')) || { key:'invoice_seq', value: (settings.invoiceSeq || 1) };
      return { meta:{ exportedAt:new Date().toISOString(), source:'InvoiceApp' }, products:productsArr, settings:settingsArr, invoices:invoicesArr, customers:customersArr, users:usersArr, counters:{ invoice_seq: seq.value || 0 } };
    }

    // =============== Elements ===============
    const invoiceNoEl = document.getElementById('invoiceNo');
    const issueDateEl = document.getElementById('issueDate');
    const customerEl = document.getElementById('customerName');
    const patientNameEl = document.getElementById('patientName');

    const customerSelect = document.getElementById('customerSelect');
    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const manageCustomersBtn = document.getElementById('manageCustomersBtn');

    const linesBody = document.getElementById('linesBody');
    const addLineBtn = document.getElementById('addLineBtn');
    const openSettingsBtn = document.getElementById('openSettingsBtn');
    const previewBtn = document.getElementById('previewBtn');
    const saveBtn = document.getElementById('saveBtn');

    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const importFileInput = document.getElementById('importFile');
    const openDbFileBtn = document.getElementById('openDbFileBtn');
    const saveDbFileBtn = document.getElementById('saveDbFileBtn');

    const subTotalEl = document.getElementById('subTotal');
    const pfChargesEl = document.getElementById('pfCharges');
    const gstAmountEl = document.getElementById('gstAmount');
    const totalAmountEl = document.getElementById('totalAmount');
    const gstPercentTxt = document.getElementById('gstPercentTxt');

    const settingsModal = document.getElementById('settingsModal');
    const discountTypeEl = document.getElementById('discountType');
    const discountValueEl = document.getElementById('discountValue');
    const pfValueEl = document.getElementById('pfValue');
    const gstPercentEl = document.getElementById('gstPercent');
    const logoUrlEl = document.getElementById('logoUrl');
    const logoFileEl = document.getElementById('logoFile');
    const showLogoEl = document.getElementById('showLogo');
    const logoWidthEl = document.getElementById('logoWidth');

    const bankAccInput = document.getElementById('bankAccInput');
    const bankIfscInput = document.getElementById('bankIfscInput');
    const bankNameInput = document.getElementById('bankNameInput');
    const bankBranchInput = document.getElementById('bankBranchInput');
    const companyNameInput = document.getElementById('companyNameInput');
    const companyRegInput = document.getElementById('companyRegInput');
    const companyAddressInput = document.getElementById('companyAddressInput');
    const companyEmailInput = document.getElementById('companyEmailInput');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const closeSettingsBtn = document.getElementById('closeSettings');

    const authUsernameEl = document.getElementById('authUsername');
    const authPasswordEl = document.getElementById('authPassword');
    const saveAuthBtn = document.getElementById('saveAuthBtn');
    const resetAuthBtn = document.getElementById('resetAuthBtn');
    const usersBodyEl = document.getElementById('usersBody');

    const invoicePrefixEl = document.getElementById('invoicePrefix');
    const invoiceSeqEl = document.getElementById('invoiceSeq');
    const applyInvoiceNumberBtn = document.getElementById('applyInvoiceNumberBtn');

    const prodDescEl = document.getElementById('prodDesc');
    const prodSizeEl = document.getElementById('prodSize');
    const prodRateEl = document.getElementById('prodRate');
    const addProdBtn = document.getElementById('addProdBtn');
    const productsBody = document.getElementById('productsBody');

    const customersBody = document.getElementById('customersBody');
    const custNameEl = document.getElementById('custName');
    const saveCustomerBtn = document.getElementById('saveCustomerBtn');

    const previewModal = document.getElementById('previewModal');
    const printInvoiceNo = document.getElementById('printInvoiceNo');
    const printBillTo = document.getElementById('printBillTo');
    const printDate = document.getElementById('printDate');
    const printLinesBody = document.getElementById('printLinesBody');
    const printLogoTop = document.getElementById('printLogoTop');
    const printLogoCenter = document.getElementById('printLogoCenter');
    const pSubTotal = document.getElementById('pSubTotal');
    const pDiscount = document.getElementById('pDiscount');
    const pPF = document.getElementById('pPF');
    const pGST = document.getElementById('pGST');
    const pTotal = document.getElementById('pTotal');
    const pGSTPercent = document.getElementById('pGSTPercent');
    const printCompanyName = document.getElementById('printCompanyName');
    const printCompanyReg = document.getElementById('printCompanyReg');
    const printCompanyAddr = document.getElementById('printCompanyAddr');
    const printCompanyEmail = document.getElementById('printCompanyEmail');
    const printBankAcc = document.getElementById('printBankAcc');
    const printBankIfsc = document.getElementById('printBankIfsc');

    const hqCheckbox = document.getElementById('highQualityPdf');
    const toggleHighQualityBtn = document.getElementById('toggleHighQualityBtn');
    const hqIndicatorPreview = document.getElementById('hqIndicatorPreview');

    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    const previewWrapper = document.getElementById('previewWrapper');

    const pdfQualityEl = document.getElementById('pdfQuality');
    const compressJpegEl = document.getElementById('compressJpeg');

    const historyBtn = document.getElementById('historyBtn');
    const historyModal = document.getElementById('historyModal');
    const historyBody = document.getElementById('historyBody');
    const closeHistoryBtn = document.getElementById('closeHistoryBtn');

    function hideAllModals(){
      previewModal.classList.add('hidden');
      settingsModal.classList.add('hidden');
      historyModal.classList.add('hidden');
    }

    // =============== State ===============
    let products = [];
    let lines = [];
    let customers = [];
    let settings = {
      splDiscountType:'percent', splDiscountValue:0, pfCharges:0, gstPercent:5,
      logoUrl:'', logoData:'', showLogo:true, logoWidth:120,
      bankAcc:'XXXXXX', bankIfsc:'IDIB0000018', bankName:'INDIAN BANK',
      bankBranch:'GUWAHATI', companyName:'M/s BONE CARE SURGICALS',
      companyReg:'18CXXPS2640JIZN', companyAddress:'Rupnagar, Kamrup Metropolitan, Assam, 781032',
      companyEmail:'bonecares@gmail.com', invoicePrefix:`INV-${new Date().getFullYear()}-`, invoiceSeq:1,
      pdfQuality:0.8, compressJpeg:true, highQualityPdf:false,
      fastExport:false, exportTextLikePreview:false
    };

    const sampleProducts = [
      { id:cryptoRandomId(), name:'DHL MEDIAL LOCKING PLATE 3.5MM (RIGHT)', size:'5 Hole', rate:4400, description:'DHL MEDIAL LOCKING PLATE 3.5MM (RIGHT)' },
      { id:cryptoRandomId(), name:'RECONSTRUCTION PLATE 3.5MM WITH LOCKING SYSTEM', size:'7 HOLE', rate:1400, description:'RECONSTRUCTION PLATE' },
      { id:cryptoRandomId(), name:'CANNULATED CANNELLOUS SCREW XL DIA 4.0 mm', size:'30 MM', rate:700, description:'CANNULATED SCREW' },
      { id:cryptoRandomId(), name:'One - Third Tubular Plate 3.5mm', size:'5 HOLE', rate:2200, description:'One-Third Tubular Plate' }
    ];

    function cryptoRandomId(){ return 'id_'+Math.random().toString(36).slice(2,9); }
    function fmt(v){return Number(v||0).toFixed(2)}
    function escapeHtml(s){
      return String(s || '').replace(/[&<>"']/g, c => ({
        '&' : '&amp;',
        '<' : '&lt;',
        '>' : '&gt;',
        '"' : '&quot;',
        "'" : '&#39;'
      })[c]);
    }
    function autoGrowTextarea(el){ if(!el) return; el.style.height='auto'; el.style.height=(el.scrollHeight)+'px'; }

    // =============== Users helpers ===============
    async function addUser(username, passwordPlain){
      if(!db.users) throw new Error('Users store not available');
      if(!username || !passwordPlain) throw new Error('username & password required');
      const existing = await db.users.where('username').equals(username).first();
      if(existing) throw new Error('Username already exists');
      const hash = await sha256hex(passwordPlain);
      return await db.users.add({ username, passwordHash: hash, createdAt: new Date().toISOString() });
    }
    async function updateUser(id, username, passwordPlain){
      if(!db.users) throw new Error('Users store not available');
      const rec = { username };
      if(passwordPlain) rec.passwordHash = await sha256hex(passwordPlain);
      await db.users.update(id, rec);
    }
    async function deleteUser(id){ if(!db.users) throw new Error('Users store not available'); await db.users.delete(id); }
    async function listUsers(){ if(!db.users) return []; return await db.users.toArray(); }
    async function renderUsersTable(){
      const body = document.getElementById('usersBody'); if(!body) return;
      const us = await listUsers().catch(()=>[]); body.innerHTML = '';
      us.forEach((u,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(u.username)}</td><td><button data-id="${u.id}" class="editUser">Edit</button> <button data-id="${u.id}" class="delUser">Delete</button></td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('.delUser').forEach(btn=> btn.addEventListener('click', async (e)=>{ if(!confirm('Delete this user?')) return; const id = Number(e.target.dataset.id); await deleteUser(id); await renderUsersTable(); await tryAutoSaveToHandle(); }));
      body.querySelectorAll('.editUser').forEach(btn=> btn.addEventListener('click', async (e)=>{ const id = Number(e.target.dataset.id); const rec = await db.users.get(id); if(!rec) return; authUsernameEl.value = rec.username || ''; authPasswordEl.value = ''; saveAuthBtn.textContent = 'Update User'; saveAuthBtn.dataset.edit = id; }));
    }
    async function seedDefaultUserIfNeeded(){
      try{
        if(!db.users) return;
        const cnt = await db.users.count().catch(()=>0);
        if(!cnt){
          const legacy = await db.settings.get('auth').catch(()=>null);
          if(legacy && legacy.value && legacy.value.username){
            const pwd = legacy.value.password || '';
            if(pwd){
              const hashed = await sha256hex(pwd);
              await db.users.add({ username: legacy.value.username, passwordHash: hashed, createdAt: new Date().toISOString() }).catch(()=>{});
            } else if(legacy.value.passwordHash){
              await db.users.add({ username: legacy.value.username, passwordHash: legacy.value.passwordHash, createdAt: new Date().toISOString() }).catch(()=>{});
            }
          } else {
            const hashed = await sha256hex('admin123');
            await db.users.add({ username:'admin', passwordHash: hashed, createdAt: new Date().toISOString() }).catch(()=>{});
          }
        }
      }catch(e){ console.warn('seed users failed', e); }
    }

    // =============== Seed / Load Settings / Customers / Products ===============
    async function ensureSeed(){
      const cnt = await db.products.count();
      if(cnt===0){ await db.products.bulkPut(sampleProducts); }
      products = await db.products.toArray(); renderProductsTable();

      try{
        const ccount = await db.customers.count();
        if(ccount===0){ await db.customers.bulkPut([{ id:cryptoRandomId(), name:'Walk-in Customer' }]); }
        customers = await db.customers.toArray(); renderCustomersTable(); populateCustomerSelect();
      }catch(e){}
      try { await seedDefaultUserIfNeeded(); } catch(e){}
    }

    async function loadSettings(){
      const s = await db.settings.get('global');
      if(s && s.value) settings = Object.assign(settings, s.value);

      discountTypeEl.value = settings.splDiscountType;
      discountValueEl.value = settings.splDiscountValue;
      pfValueEl.value = settings.pfCharges;
      gstPercentEl.value = settings.gstPercent;
      logoUrlEl.value = settings.logoUrl || '';
      showLogoEl.checked = !!settings.showLogo;
      logoWidthEl.value = settings.logoWidth || 120;

      companyNameInput.value = settings.companyName || '';
      companyRegInput.value = settings.companyReg || '';
      companyAddressInput.value = settings.companyAddress || '';
      companyEmailInput.value = settings.companyEmail || '';
      bankAccInput.value = settings.bankAcc || '';
      bankIfscInput.value = settings.bankIfsc || '';
      bankNameInput.value = settings.bankName || '';
      bankBranchInput.value = settings.bankBranch || '';

      gstPercentTxt.textContent = settings.gstPercent;

      if(invoicePrefixEl) invoicePrefixEl.value = settings.invoicePrefix || (`INV-${new Date().getFullYear()}-`);
      if(invoiceSeqEl) invoiceSeqEl.value = (typeof settings.invoiceSeq !== 'undefined') ? Number(settings.invoiceSeq) : 1;

      // preview company
      printCompanyName.textContent = settings.companyName;
      printCompanyReg.textContent = settings.companyReg;
      printCompanyAddr.textContent = settings.companyAddress;
      printCompanyEmail.textContent = settings.companyEmail;
      printBankAcc.textContent = settings.bankAcc;
      printBankIfsc.textContent = settings.bankIfsc;

      setLogos();
      pdfQualityEl.value = (typeof settings.pdfQuality !== 'undefined') ? settings.pdfQuality : 0.8;
      compressJpegEl.checked = !!settings.compressJpeg;

      if(hqCheckbox) hqCheckbox.checked = !!settings.highQualityPdf;
      updateHighQualityUi();

      const fastExportEl = document.getElementById('fastExport');
      if (fastExportEl) fastExportEl.checked = !!settings.fastExport;
      const exportTextChk = document.getElementById('exportTextLikePreview');
      if (exportTextChk) exportTextChk.checked = !!settings.exportTextLikePreview;
    }

    function setLogos(){
      const src = settings.logoData || settings.logoUrl || '';
      [printLogoTop, printLogoCenter].forEach(el=>{
        if(!el) return;
        if(!settings.showLogo || !src){ el.style.display='none'; el.removeAttribute('src'); }
        else {
          el.style.display='block';
          el.src = src;
          const w = Number(settings.logoWidth)||120;
          el.style.maxWidth = w+'px';
          el.style.width = w+'px';
          el.style.height = 'auto';
        }
      });
    }

    function applyLogoVisibility(){ setLogos(); }

    // =============== Products / Customers UI ===============
    function renderProductsTable(){
      productsBody.innerHTML = '';
      products.forEach((p,i)=>{
        const tr = document.createElement('tr');
        const desc = escapeHtml(p.description || p.name || '');
        tr.innerHTML = `<td>${i+1}</td><td style="white-space:pre-line;max-width:420px">${desc}</td><td>${escapeHtml(p.size||'')}</td><td style='text-align:right'>${fmt(p.rate)}</td><td><button data-id='${p.id}' class='editProd'>Edit</button> <button data-id='${p.id}' class='delProd'>Delete</button></td>`;
        productsBody.appendChild(tr);
      });
      productsBody.querySelectorAll('.delProd').forEach(btn=> btn.addEventListener('click', async (e)=>{ const id=e.target.dataset.id; await db.products.delete(id); products = await db.products.toArray(); renderProductsTable(); renderLines(); calcTotals(); await tryAutoSaveToHandle(); }));
      productsBody.querySelectorAll('.editProd').forEach(btn=> btn.addEventListener('click', (e)=>{ const id=e.target.dataset.id; const p = products.find(x=>x.id===id); if(!p) return; prodDescEl.value = p.description || p.name || ''; prodSizeEl.value = p.size||''; prodRateEl.value = p.rate||0; addProdBtn.dataset.edit = id; addProdBtn.textContent='Update Product'; autoGrowTextarea(prodDescEl); }));
      setTimeout(()=> autoGrowTextarea(prodDescEl), 50);
    }

    function renderCustomersTable(){
      customersBody.innerHTML = '';
      customers.forEach((c,i)=>{
        const tr = document.createElement('tr');
        const previewLine = (String(c.name||'').split('\n')[0]||'').replace(/\s+/g,' ').trim();
        tr.innerHTML = `<td>${i+1}</td><td style="white-space:pre-line;max-width:420px">${escapeHtml(previewLine)}</td><td><button data-id='${c.id}' class='editCust'>Edit</button> <button data-id='${c.id}' class='delCust'>Delete</button></td>`;
        customersBody.appendChild(tr);
      });
      customersBody.querySelectorAll('.delCust').forEach(btn=> btn.addEventListener('click', async (e)=>{ const id=e.target.dataset.id; await db.customers.delete(id); customers = await db.customers.toArray(); renderCustomersTable(); populateCustomerSelect(); await tryAutoSaveToHandle(); }));
      customersBody.querySelectorAll('.editCust').forEach(btn=> btn.addEventListener('click', (e)=>{ const id=e.target.dataset.id; const c = customers.find(x=>x.id===id); if(!c) return; custNameEl.value = c.name; saveCustomerBtn.dataset.edit = id; }));
    }

    function populateCustomerSelect(){
      customerSelect.innerHTML = '';
      const opt = document.createElement('option'); opt.value=''; opt.textContent='-- select customer --'; customerSelect.appendChild(opt);
      customers.forEach(c=>{
        const o = document.createElement('option'); o.value = c.id; o.textContent = (String(c.name||'').split('\n')[0]||'').replace(/\s+/g,' ').trim(); customerSelect.appendChild(o);
      });
      const addOpt = document.createElement('option'); addOpt.value='__add__'; addOpt.textContent = 'Add new customer...'; customerSelect.appendChild(addOpt);
    }

    if(prodDescEl){ prodDescEl.addEventListener('input', ()=> autoGrowTextarea(prodDescEl)); prodDescEl.addEventListener('focus', ()=> autoGrowTextarea(prodDescEl)); }
    if(customerEl){ customerEl.addEventListener('input', ()=> autoGrowTextarea(customerEl)); }

    addProdBtn.addEventListener('click', async ()=>{
      const description = (prodDescEl.value||'').trim();
      const name = (description.split('\n')[0]||description).trim();
      const size = (prodSizeEl.value||'').trim();
      const rate = Number(prodRateEl.value||0);
      if(!description) return alert('Enter product description');
      if(addProdBtn.dataset.edit){
        const id = addProdBtn.dataset.edit;
        await db.products.update(id,{ description, name, size, rate });
        delete addProdBtn.dataset.edit; addProdBtn.textContent='Add Product';
      } else {
        await db.products.put({ id: cryptoRandomId(), name, size, rate, description });
      }
      prodDescEl.value=''; prodSizeEl.value=''; prodRateEl.value='';
      products = await db.products.toArray();
      renderProductsTable(); renderLines(); calcTotals(); autoGrowTextarea(prodDescEl);
      await tryAutoSaveToHandle();
    });

    saveCustomerBtn.addEventListener('click', async ()=>{
      const name = (custNameEl.value||'').trim(); if(!name) return alert('Enter customer');
      if(saveCustomerBtn.dataset.edit){ const id = saveCustomerBtn.dataset.edit; await db.customers.update(id,{ name }); delete saveCustomerBtn.dataset.edit; saveCustomerBtn.textContent='Save Customer'; }
      else { const id = cryptoRandomId(); await db.customers.put({ id, name }); }
      custNameEl.value=''; customers = await db.customers.toArray(); renderCustomersTable(); populateCustomerSelect();
      await tryAutoSaveToHandle();
    });

    addCustomerBtn.addEventListener('click', async ()=>{
      const name = prompt('Customer name'); if(!name) return;
      const id = cryptoRandomId(); await db.customers.put({ id, name: name.trim() });
      customers = await db.customers.toArray(); renderCustomersTable(); populateCustomerSelect();
      customerSelect.value = id; customerEl.value = name.trim(); autoGrowTextarea(customerEl);
      await tryAutoSaveToHandle();
    });

    manageCustomersBtn.addEventListener('click', ()=>{ openSettingsBtn.click(); setTimeout(()=>{ const el = document.getElementById('custName'); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}); },150); });

    customerSelect.addEventListener('change', (e)=>{
      const val = e.target.value;
      if(val === '__add__'){ addCustomerBtn.click(); return; }
      const c = customers.find(x=>x.id===val);
      if(c){ customerEl.value = c.name; autoGrowTextarea(customerEl); } else { customerEl.value = ''; }
    });

    // =============== Lines & Totals ===============
    function createLineRow(line, idx){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>
          <select class='prod-select'>
            <option value=''>-- select product --</option>
            ${products.map(p => `<option value='${p.id}' ${line.productId===p.id?'selected':''}>${escapeHtml((p.name||'').toString())}</option>`).join('')}
          </select>
          <div style='font-size:11px;color:#666;white-space:pre-line'>${escapeHtml(line.description||'')}</div>
        </td>
        <td class='size-cell'>${escapeHtml(line.size||'')}</td>
        <td><input class='rate-input' type='number' value='${line.rate||0}' /></td>
        <td><input class='qty-input' type='number' min='0' value='${line.qty||1}' /></td>
        <td class='amount-cell' style='text-align:right'>${fmt(line.amount||0)}</td>
        <td><button class='action-btn small minus-btn' title='Remove line'>−</button><button class='action-btn small plus-btn' title='Add line after'>+</button></td>
      `;
      tr.querySelector('.prod-select').addEventListener('change', (e)=>{
        const pid = e.target.value; const p = products.find(x=>x.id===pid) || {};
        lines[idx].productId = pid;
        lines[idx].description = p.description || p.name || '';
        lines[idx].size = p.size || '';
        lines[idx].rate = Number(p.rate || 0);
        lines[idx].qty = Number(lines[idx].qty || 1);
        lines[idx].amount = lines[idx].rate * lines[idx].qty;
        renderLines(); calcTotals();
      });
      tr.querySelector('.rate-input').addEventListener('input', (e)=>{ lines[idx].rate = Number(e.target.value||0); lines[idx].amount = lines[idx].rate * lines[idx].qty; renderLines(); calcTotals(); });
      tr.querySelector('.qty-input').addEventListener('input', (e)=>{ lines[idx].qty = Number(e.target.value||0); lines[idx].amount = lines[idx].rate * lines[idx].qty; renderLines(); calcTotals(); });
      tr.querySelector('.minus-btn').addEventListener('click', ()=>{ lines.splice(idx,1); renderLines(); calcTotals(); });
      tr.querySelector('.plus-btn').addEventListener('click', ()=>{ lines.splice(idx+1,0,{productId:'',description:'',size:'',rate:0,qty:1,amount:0}); renderLines(); calcTotals(); });
      return tr;
    }

    function renderLines(){
      linesBody.innerHTML = '';
      if(lines.length===0) lines.push({productId:'',description:'',size:'',rate:0,qty:1,amount:0});
      lines.forEach((l,i)=> linesBody.appendChild(createLineRow(l,i)));
    }

    function calcTotals(){
      const sub = lines.reduce((s,l)=> s + (Number(l.amount)||0), 0);
      const discount = settings.splDiscountType==='percent' ? sub * (Number(settings.splDiscountValue||0)/100)
                                                           : Number(settings.splDiscountValue||0);
      const pf = Number(settings.pfCharges||0);
      const taxable = sub - discount + pf;
      const gst = taxable * (Number(settings.gstPercent||0)/100);
      const total = taxable + gst;

      subTotalEl.textContent = fmt(sub);
      document.getElementById('splDiscount').textContent = fmt(discount || 0);
      pfChargesEl.textContent = fmt(pf);
      gstAmountEl.textContent = fmt(gst);
      totalAmountEl.textContent = fmt(total);

      pSubTotal.textContent = fmt(sub);
      pDiscount.textContent = fmt(discount || 0);
      pPF.textContent = fmt(pf);
      pGST.textContent = fmt(gst);
      pTotal.textContent = fmt(total);
      pGSTPercent.textContent = settings.gstPercent;

      return { sub, discount, pf, gst, total };
    }

    addLineBtn.addEventListener('click', ()=>{ lines.push({productId:'',description:'',size:'',rate:0,qty:1,amount:0}); renderLines(); calcTotals(); });

    // =============== Settings actions ===============
    openSettingsBtn.addEventListener('click', async ()=>{ hideAllModals(); await ensureSeed(); await loadSettings(); await renderUsersTable(); settingsModal.classList.remove('hidden'); setTimeout(()=>{ autoGrowTextarea(prodDescEl); }, 60); });
    closeSettingsBtn.addEventListener('click', ()=> settingsModal.classList.add('hidden'));

    function downscaleDataUrlIfNeeded(dataUrl, maxWidth=2000){
      return new Promise((resolve)=>{
        try{
          const img = new Image();
          img.onload = function(){
            if(img.width <= maxWidth){ resolve(dataUrl); return; }
            const scale = maxWidth / img.width;
            const canvas = document.createElement('canvas');
            canvas.width = Math.round(img.width * scale);
            canvas.height = Math.round(img.height * scale);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            const isPNG = dataUrl.indexOf('image/png') !== -1;
            const out = canvas.toDataURL(isPNG ? 'image/png' : 'image/jpeg', 0.95);
            resolve(out);
          };
          img.onerror = function(){ resolve(dataUrl); };
          img.src = dataUrl;
        }catch(e){ resolve(dataUrl); }
      });
    }

    saveSettingsBtn.addEventListener('click', async ()=>{
      settings.splDiscountType = discountTypeEl.value;
      settings.splDiscountValue = Number(discountValueEl.value||0);
      settings.pfCharges = Number(pfValueEl.value||0);
      settings.gstPercent = Number(gstPercentEl.value||5);
      settings.logoUrl = logoUrlEl.value || '';
      settings.showLogo = !!showLogoEl.checked;
      settings.logoWidth = Number(logoWidthEl.value) || 120;

      settings.companyName = companyNameInput.value || settings.companyName;
      settings.companyReg = companyRegInput.value || settings.companyReg;
      settings.companyAddress = companyAddressInput.value || settings.companyAddress;
      settings.companyEmail = companyEmailInput.value || settings.companyEmail;
      settings.bankAcc = bankAccInput.value || settings.bankAcc;
      settings.bankIfsc = bankIfscInput.value || settings.bankIfsc;
      settings.bankName = bankNameInput.value || settings.bankName;
      settings.bankBranch = bankBranchInput.value || settings.bankBranch;

      settings.invoicePrefix = (invoicePrefixEl && invoicePrefixEl.value) ? String(invoicePrefixEl.value) : (`INV-${new Date().getFullYear()}-`);
      settings.invoiceSeq = (invoiceSeqEl && Number(invoiceSeqEl.value)) || settings.invoiceSeq || 1;

      settings.pdfQuality = Number(pdfQualityEl.value) || 0.8;
      settings.compressJpeg = !!compressJpegEl.checked;

      settings.highQualityPdf = !!(hqCheckbox && hqCheckbox.checked);
      settings.fastExport = !!document.getElementById('fastExport').checked;
      settings.exportTextLikePreview = !!document.getElementById('exportTextLikePreview')?.checked;

      await db.settings.put({ key:'global', value: settings });

      if(logoFileEl.files && logoFileEl.files[0]){
        const f = logoFileEl.files[0];
        const reader = new FileReader();
        reader.onload = async function(e){
          let base64 = e.target.result;
          base64 = await downscaleDataUrlIfNeeded(base64, 2400);
          settings.logoData = base64;
          await db.settings.put({key:'global', value:settings});
          await loadSettings();
          settingsModal.classList.add('hidden');
          await tryAutoSaveToHandle();
        };
        reader.readAsDataURL(f);
      } else {
        await loadSettings();
        settingsModal.classList.add('hidden');
        await tryAutoSaveToHandle();
      }
    });

    if(applyInvoiceNumberBtn){
      applyInvoiceNumberBtn.addEventListener('click', async ()=>{
        const prefix = (invoicePrefixEl?.value || `INV-${new Date().getFullYear()}-`);
        const seq = (invoiceSeqEl?.value ? Number(invoiceSeqEl.value) : settings.invoiceSeq || 1);
        const applied = formatInvoice(prefix, seq);
        invoiceNoEl.value = applied;
        settings.invoicePrefix = prefix; settings.invoiceSeq = seq;
        await db.settings.put({ key:'global', value: settings });
        alert('Invoice number set: ' + applied + '\n(Sequence advances after PDF export.)');
      });
    }

    if(toggleHighQualityBtn){
      toggleHighQualityBtn.addEventListener('click', async ()=>{
        settings.highQualityPdf = !settings.highQualityPdf;
        if(hqCheckbox) hqCheckbox.checked = settings.highQualityPdf;
        updateHighQualityUi();
        await db.settings.put({ key:'global', value: settings });
        await tryAutoSaveToHandle();
      });
    }

    function updateHighQualityUi(){
      const enabled = !!settings.highQualityPdf;
      if(toggleHighQualityBtn) toggleHighQualityBtn.textContent = enabled ? 'Disable High Quality' : 'Enable High Quality';
      if(hqIndicatorPreview) (enabled ? hqIndicatorPreview.classList.remove('hidden') : hqIndicatorPreview.classList.add('hidden'));
    }

    // =============== Save (Offline) ===============
    saveBtn.addEventListener('click', async ()=>{
      const invoiceNumberToSave = await generateInvoiceNumber();
      const t = calcTotals();
      const rec = {
        invoiceNumber: invoiceNumberToSave,
        issueDate: issueDateEl.value,
        customer: customerEl.value,
        patientName: patientNameEl.value,
        items: JSON.parse(JSON.stringify(lines)),
        totals: { subTotal: fmt(t.sub), discount: fmt(t.discount), pf: fmt(t.pf), gst: fmt(t.gst), total: fmt(t.total) },
        source: 'manual-save',
        createdAt: new Date().toISOString()
      };
      await db.invoices.add(rec);
      invoiceNoEl.value = await peekNextInvoiceNumber();
      alert('Invoice saved offline as ' + invoiceNumberToSave);
      await tryAutoSaveToHandle();
    });

    // =============== Preview fill ===============
    previewBtn.addEventListener('click', ()=>{
      hideAllModals();

      printInvoiceNo.textContent = invoiceNoEl.value;
      printDate.textContent = issueDateEl.value || new Date().toISOString().slice(0,10);
      document.getElementById("billToBox").textContent = customerEl.value || "";

      const patientBox = document.getElementById("printPatientNameBox");
if (patientBox) {
  patientBox.textContent = (patientNameEl.value || "");
  patientBox.style.height = "auto";
  patientBox.style.height = patientBox.scrollHeight + "px";
}


      setLogos();

      printBankAcc.textContent = settings.bankAcc || '';
      printBankIfsc.textContent = settings.bankIfsc || '';
      printCompanyName.textContent = settings.companyName;
      printCompanyReg.textContent = settings.companyReg;
      printCompanyAddr.textContent = settings.companyAddress;
      printCompanyEmail.textContent = settings.companyEmail;

      printLinesBody.innerHTML = '';
      lines.forEach((l,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td style="white-space:pre-line">${escapeHtml(l.description||'')}</td><td>${escapeHtml(l.size||'')}</td><td style='text-align:right'>${fmt(l.rate)}</td><td style='text-align:right'>${l.qty}</td><td style='text-align:right'>${fmt(l.amount)}</td>`;
        printLinesBody.appendChild(tr);
      });

      const mode = document.querySelector('input[name="previewMode"]:checked')?.value || 'desktop';
      if(mode==='mobile'){ previewWrapper.classList.remove('preview-mode-desktop'); previewWrapper.classList.add('preview-mode-mobile'); }
      else { previewWrapper.classList.remove('preview-mode-mobile'); previewWrapper.classList.add('preview-mode-desktop'); }

      if(settings.highQualityPdf) hqIndicatorPreview.classList.remove('hidden'); else hqIndicatorPreview.classList.add('hidden');
      previewModal.classList.remove('hidden');
    });

    document.querySelectorAll('input[name="previewMode"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const mode = document.querySelector('input[name="previewMode"]:checked')?.value || 'desktop';
        if(mode==='mobile'){ previewWrapper.classList.remove('preview-mode-desktop'); previewWrapper.classList.add('preview-mode-mobile'); }
        else { previewWrapper.classList.remove('preview-mode-mobile'); previewWrapper.classList.add('preview-mode-desktop'); }
      });
    });

    closePreviewBtn.addEventListener('click', ()=> previewModal.classList.add('hidden'));

    // =============== PDF Helpers ===============
    function sliceCanvasToPages(originalCanvas, pageHeightPx){
      const slices = []; const fullH = originalCanvas.height; let y = 0;
      while(y < fullH){
        const sliceH = Math.min(pageHeightPx, fullH - y);
        const tmp = document.createElement('canvas');
        tmp.width = originalCanvas.width; tmp.height = sliceH;
        const ctx = tmp.getContext('2d'); ctx.drawImage(originalCanvas, 0, y, originalCanvas.width, sliceH, 0, 0, originalCanvas.width, sliceH);
        slices.push(tmp); y += sliceH;
      }
      return slices;
    }

function printPreviewAsTextPdf(){
  const area = document.getElementById('previewArea');
  if(!area){ 
    alert('Open Preview first, then click Export.');
    return;
  }

  const headContent = `
    <meta charset="utf-8">
    <title>Invoice Print Preview</title>
    <style>
      html, body {
        background:#fff;
        margin:0;
        padding:0;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      @page { size: A4; margin: 10mm; }
      #previewArea {
        transform:none !important;
        width:842px !important;
        min-height:1191px !important;
        box-shadow:none !important;
        border:none !important;
        background:#fff !important;
        margin:0 auto !important;
      }
      .preview-wrapper, .preview-scaler {
        transform:none !important;
        scale:1 !important;
        padding:0 !important;
        margin:0 !important;
      }
      #exportPdfBtn, #closePreviewBtn,
      .preview-controls, .controls {
        display:none !important;
      }
      * {
        color-adjust: exact !important;
        -webkit-print-color-adjust: exact !important;
      }
    </style>
  `;

  const printHtml = `
    <!doctype html>
    <html>
      <head>${headContent}</head>
      <body>${area.outerHTML}</body>
    </html>
  `;

  const printWin = window.open('', '_blank', 'width=900,height=1200');
  printWin.document.open();
  printWin.document.write(printHtml);
  printWin.document.close();

  // Delay a bit to ensure render
  printWin.onload = function(){
    setTimeout(()=>{ printWin.print(); }, 250);
  };
}


    async function storeInvoiceSnapshot(sourceTag){
      const t = calcTotals();
      const rec = {
        invoiceNumber: (invoiceNoEl.value || await generateInvoiceNumber()),
        issueDate: issueDateEl.value,
        customer: customerEl.value,
        patientName: patientNameEl.value,
        items: JSON.parse(JSON.stringify(lines)),
        totals: { subTotal: fmt(t.sub), discount: fmt(t.discount), pf: fmt(t.pf), gst: fmt(t.gst), total: fmt(t.total) },
        source: sourceTag || 'pdf-export',
        createdAt: new Date().toISOString()
      };
      await db.invoices.add(rec);
      await tryAutoSaveToHandle();
      return rec.invoiceNumber;
    }

    // Single export handler
    exportPdfBtn.onclick = async (e) => {
      try{
        e?.preventDefault?.();

        // Browser-print text export
        if (settings.exportTextLikePreview) {
          await storeInvoiceSnapshot('pdf-text-browser-print');
          invoiceNoEl.value = await peekNextInvoiceNumber();
          try { printInvoiceNo.textContent = invoiceNoEl.value; } catch(e){}
          printPreviewAsTextPdf();
          return;
        }

        // Image snapshot export
        const el = document.getElementById('previewArea');
        if(!el){
          alert('Open Preview first, then click Export.');
          return;
        }

        applyLogoVisibility();

        const { jsPDF } = window.jspdf;
        const highQuality = !!settings.highQualityPdf;
        const quality = (typeof settings.pdfQuality !== 'undefined') ? Number(settings.pdfQuality) : 0.8;
        const useJpeg = !highQuality && (typeof settings.compressJpeg !== 'undefined'
                          ? !!settings.compressJpeg
                          : !!document.getElementById('compressJpeg')?.checked);

        const dpr = Math.min(3, window.devicePixelRatio || 1);
        const baseScale = Math.max(1.5, dpr * 1.5);
        const canvasScale = settings.fastExport ? 1.2
                          : (highQuality ? Math.max(2.5, dpr * 2.8) : baseScale);


// Temporarily hide export/close buttons before capturing
const exportBtn = document.getElementById("exportPdfBtn");
const closeBtn = document.getElementById("closePreviewBtn");

if (exportBtn) exportBtn.style.display = "none";
if (closeBtn) closeBtn.style.display = "none";

await new Promise(r => setTimeout(r, 80)); // short delay to let layout update

        const canvas = await html2canvas(el, {
          scale: canvasScale,
          useCORS: true,
          allowTaint: false,
          logging: false,
          scrollY: -window.scrollY
        });

        const pdf = new jsPDF('p','mm','a4');
        const A4_W = 210, A4_H = 297, M = 10;
        const pxPerMm = canvas.width / (A4_W - M*2);
        const pageHeightPx = Math.floor((A4_H - M*2) * pxPerMm);
        const slices = sliceCanvasToPages(canvas, pageHeightPx);

        const imgType = highQuality ? 'PNG' : (useJpeg ? 'JPEG' : 'PNG');
        const mime    = highQuality ? 'image/png' : (useJpeg ? 'image/jpeg' : 'image/png');

        slices.forEach((c,i)=>{
          const dataUrl = c.toDataURL(mime, useJpeg ? quality : undefined);
          const imgWmm = A4_W - M*2;
          const imgHmm = c.height / pxPerMm;
          if(i>0) pdf.addPage();
          pdf.addImage(dataUrl, imgType, M, M, imgWmm, imgHmm, undefined, 'FAST');
        });

        const filename = (invoiceNoEl.value || 'invoice') + '_preview.pdf';
        pdf.save(filename);
// Restore buttons after export
if (exportBtn) exportBtn.style.display = "";
if (closeBtn) closeBtn.style.display = "";


        await storeInvoiceSnapshot('pdf-image-export');
        invoiceNoEl.value = await peekNextInvoiceNumber();
        try { printInvoiceNo.textContent = invoiceNoEl.value; } catch(e){}

        alert('✅ Exported the current preview.');
      }catch(err){
        console.error(err);
        alert('Export failed: ' + (err.message || err));
      }
    };

    // Download PDF for a given invoice ID without showing preview
    async function downloadInvoicePdfById(id){
      const inv = await db.invoices.get(id);
      if(!inv) return alert('Invoice not found');

      loadInvoiceToEditor(inv);

      const wasHidden = previewModal.classList.contains('hidden');
      previewModal.classList.remove('hidden');
      previewModal.style.visibility = 'hidden';
      previewModal.style.pointerEvents = 'none';

      await new Promise(r => setTimeout(r, 30));

      try{
        const { jsPDF } = window.jspdf;
        const el = document.getElementById('previewArea');
        applyLogoVisibility();

        const highQuality = !!settings.highQualityPdf;
        const quality = (typeof settings.pdfQuality !== 'undefined') ? Number(settings.pdfQuality) : 0.8;
        const useJpeg = !highQuality && (typeof settings.compressJpeg !== 'undefined'
                        ? !!settings.compressJpeg
                        : !!document.getElementById('compressJpeg')?.checked);

        const dpr = Math.min(3, window.devicePixelRatio || 1);
        const baseScale = Math.max(1.5, dpr * 1.5);
        const canvasScale = settings.fastExport ? 1.2
                          : (highQuality ? Math.max(2.5, dpr * 2.8) : baseScale);

        const canvas = await html2canvas(el, {
          scale: canvasScale,
          useCORS: true,
          allowTaint: false,
          logging: false,
          scrollY: -window.scrollY
        });

        const pdf = new jsPDF('p','mm','a4');
        const A4_W = 210, A4_H = 297, M = 10;
        const pxPerMm = canvas.width / (A4_W - M*2);
        const pageHeightPx = Math.floor((A4_H - M*2) * pxPerMm);
        const slices = sliceCanvasToPages(canvas, pageHeightPx);

        const imgType = highQuality ? 'PNG' : (useJpeg ? 'JPEG' : 'PNG');
        const mime    = highQuality ? 'image/png' : (useJpeg ? 'image/jpeg' : 'image/png');

        slices.forEach((c,i)=>{
          const dataUrl = c.toDataURL(mime, useJpeg ? quality : undefined);
          const imgWmm = A4_W - M*2;
          const imgHmm = c.height / pxPerMm;
          if(i>0) pdf.addPage();
          pdf.addImage(dataUrl, imgType, M, M, imgWmm, imgHmm, undefined, 'FAST');
        });

        const filename = (inv.invoiceNumber || 'invoice') + '_preview.pdf';
        pdf.save(filename);
      }catch(err){
        console.error(err);
        alert('Download failed: ' + (err.message || err));
      }finally{
        if(wasHidden) previewModal.classList.add('hidden');
        previewModal.style.visibility = '';
        previewModal.style.pointerEvents = '';
      }
    }

    // =============== History ===============
    function buildProductsHtml(items){
      const arr = Array.isArray(items) ? items : [];
      if(!arr.length) return '<span style="color:#666">No items</span>';

      const header = `
        <thead>
          <tr>
            <th>#</th>
            <th>Description</th>
            <th>Size</th>
            <th class="t-right">Qty</th>
            <th class="t-right">Rate</th>
            <th class="t-right">Amount</th>
          </tr>
        </thead>`;

      const rows = arr.map((l, i) => {
        const qty  = Number(l?.qty || 0);
        const rate = Number(l?.rate || 0);
        const amt  = (typeof l?.amount === 'number') ? l.amount : qty * rate;

        return `
          <tr>
            <td>${i + 1}</td>
            <td class="desc">${escapeHtml(l?.description || '')}</td>
            <td>${escapeHtml(l?.size || '')}</td>
            <td class="t-right">${qty}</td>
            <td class="t-right">${fmt(rate)}</td>
            <td class="t-right">${fmt(amt)}</td>
          </tr>`;
      }).join('');

      return `
        <div class="products-wrap">
          <table class="mini-table">
            ${header}
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    function loadInvoiceToEditor(inv) {
      if (!inv) return;

      invoiceNoEl.value = inv.invoiceNumber || '';
      issueDateEl.value = inv.issueDate || new Date().toISOString().slice(0,10);
      customerEl.value = inv.customer || '';
      patientNameEl.value = inv.patientName || '';

      lines = (inv.items && Array.isArray(inv.items)) ? JSON.parse(JSON.stringify(inv.items)) : [];
      if (!lines.length) lines = [{ productId:'', description:'', size:'', rate:0, qty:1, amount:0 }];

      renderLines();
      calcTotals();

      // Fill preview fields for export
      printInvoiceNo.textContent = inv.invoiceNumber || '';
      printDate.textContent = inv.issueDate || '';
      printBillTo.textContent = inv.customer || '';
      printPatientName.textContent = inv.patientName || '';

      printLinesBody.innerHTML = '';
      lines.forEach((l, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td style="white-space:pre-line">${escapeHtml(l.description || '')}</td>
          <td>${escapeHtml(l.size || '')}</td>
          <td style="text-align:right">${fmt(l.rate)}</td>
          <td style="text-align:right">${l.qty}</td>
          <td style="text-align:right">${fmt(l.amount)}</td>`;
        printLinesBody.appendChild(tr);
      });

      setLogos();
      printBankAcc.textContent = settings.bankAcc || '';
      printBankIfsc.textContent = settings.bankIfsc || '';
      printCompanyName.textContent = settings.companyName || '';
      printCompanyReg.textContent = settings.companyReg || '';
      printCompanyAddr.textContent = settings.companyAddress || '';
      printCompanyEmail.textContent = settings.companyEmail || '';
    }

    async function loadHistory(){
      const list = await db.invoices.toArray();
      list.sort((a,b)=> new Date(b.createdAt||0) - new Date(a.createdAt||0));
      historyBody.innerHTML = '';

      list.forEach((inv,i)=>{
        const billTo = String(inv.customer || '').trim();
        const billToFirstLine = (billTo.split('\n')[0] || '').replace(/\s+/g,' ').trim();

        const items = inv.items?.length ? inv.items : (inv.lines || []);
        const itemCount = items.length;
        const productsHtml = buildProductsHtml(items);

        const patient = inv.patientName || inv.patient || '';
        const total = inv.totals?.total || inv.total || '0.00';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${escapeHtml(inv.invoiceNumber||'')}</td>
          <td>${escapeHtml(inv.issueDate||'')}</td>
          <td style="white-space:pre-line">${escapeHtml(billToFirstLine)}</td>
          <td style="white-space:pre-line">${escapeHtml(patient)}</td>
          <td class="products-cell">${productsHtml}</td>
          <td style="text-align:right">${itemCount}</td>
          <td style="text-align:right">${escapeHtml(total)}</td>
          <td>
            <button type="button" class="viewInv" data-id="${inv.id}">Load</button>
            <button type="button" class="pdfInv"  data-id="${inv.id}">Re-Export PDF</button>
            <button type="button" class="csvInv"  data-id="${inv.id}">Export CSV</button>
            <button type="button" class="dlInv"   data-id="${inv.id}">Download PDF</button>
            <button type="button" class="delInv"  data-id="${inv.id}">Delete</button>
          </td>`;
        historyBody.appendChild(tr);
      });
    }

    // Single delegated handler for all History row buttons
    historyBody.addEventListener('click', async (e) => {
      const btn = e.target;
      if(!(btn instanceof HTMLElement)) return;
      const id = Number(btn.dataset.id);

      if(btn.classList.contains('delInv')){
        if(confirm('Delete this invoice record from history?')){
          await db.invoices.delete(id);
          await loadHistory();
          await tryAutoSaveToHandle();
        }
        return;
      }

      if(btn.classList.contains('viewInv')){
        const inv = await db.invoices.get(id);
        if(inv){ loadInvoiceToEditor(inv); historyModal.classList.add('hidden'); }
        return;
      }

      if(btn.classList.contains('pdfInv')){
        const inv = await db.invoices.get(id);
        if(!inv) return;
        loadInvoiceToEditor(inv);
        previewBtn.click(); // open preview ready to export
        return;
      }

      if(btn.classList.contains('csvInv')){
        await exportSingleInvoiceCSV(id);
        return;
      }

      if(btn.classList.contains('dlInv')){
        await downloadInvoicePdfById(id);
        return;
      }
    });

    historyBtn.addEventListener('click', async ()=>{
      hideAllModals();           // make sure nothing covers it
      await loadHistory();
      historyModal.classList.remove('hidden');
    });

    closeHistoryBtn.addEventListener('click', ()=> historyModal.classList.add('hidden'));

    // CSV EXPORT
    document.getElementById("exportAllCsvBtn").addEventListener("click", exportAllInvoicesCSV);

    function convertInvoiceToCSV(inv) {
      const headers = [
        "Invoice Number", "Issue Date", "Customer", "Patient Name",
        "Item #", "Description", "Size", "Rate", "Quantity", "Amount",
        "Sub Total", "Discount", "P&F", "GST", "Total"
      ];

      const rows = [];
      const items = inv.items || [];

      items.forEach((item, i) => {
        rows.push([
          inv.invoiceNumber || "",
          inv.issueDate || "",
          (inv.customer || "").replace(/\n/g, " "),
          (inv.patientName || "").replace(/\n/g, " "),
          i + 1,
          (item.description || "").replace(/\n/g, " "),
          item.size || "",
          item.rate || "",
          item.qty || "",
          item.amount || "",
          inv.totals?.subTotal || "",
          inv.totals?.discount || "",
          inv.totals?.pf || "",
          inv.totals?.gst || "",
          inv.totals?.total || ""
        ]);
      });

      let csvContent = headers.join(",") + "\n";
      rows.forEach(r => { csvContent += r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",") + "\n"; });
      return csvContent;
    }

    function downloadCSV(content, filename = "invoices.csv") {
      const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function exportSingleInvoiceCSV(id) {
      const inv = await db.invoices.get(id);
      if (!inv) return alert("Invoice not found");
      const csv = convertInvoiceToCSV(inv);
      const filename = (inv.invoiceNumber || "invoice") + ".csv";
      downloadCSV(csv, filename);
    }

    async function exportAllInvoicesCSV() {
      const all = await db.invoices.toArray();
      if (!all.length) return alert("No invoices to export");

      let combinedCSV = "";
      all.forEach(inv => {
        combinedCSV += convertInvoiceToCSV(inv) + "\n";
      });

      downloadCSV(combinedCSV, "all_invoices.csv");
      alert(`Exported ${all.length} invoices to CSV`);
    }

    // =============== Numbering helpers ===============
    function formatInvoice(prefix, seq){ return `${prefix}${String(seq).padStart(5,'0')}`; }

    async function peekNextInvoiceNumber(){
      settings.invoicePrefix = settings.invoicePrefix || (`INV-${new Date().getFullYear()}-`);
      const seqRec = await db.settings.get('invoice_seq');
      const seqFromDB = (seqRec && typeof seqRec.value !== 'undefined') ? Number(seqRec.value) : (settings.invoiceSeq || 1);
      const allInv = await db.invoices.toArray().catch(()=>[]);
      let maxSeq = 0;
      const prefix = settings.invoicePrefix;
      for(const inv of allInv){
        if(!inv || !inv.invoiceNumber) continue;
        if(typeof inv.invoiceNumber !== 'string') continue;
        if(inv.invoiceNumber.startsWith(prefix)){
          const tail = inv.invoiceNumber.slice(prefix.length).replace(/^0+/, '') || '0';
          const n = Number(tail);
          if(!isNaN(n) && n > maxSeq) maxSeq = n;
        } else {
          const m = inv.invoiceNumber.match(/(\d+)$/);
          if(m){ const n = Number(m[1]); if(!isNaN(n) && n > maxSeq) maxSeq = n; }
        }
      }
      const candidate = Math.max(maxSeq + 1, seqFromDB);
      return formatInvoice(prefix, candidate);
    }

    async function generateInvoiceNumber() {
      settings.invoicePrefix = settings.invoicePrefix || (`INV-${new Date().getFullYear()}-`);

      const allInv = await db.invoices.toArray().catch(() => []);
      let maxSeq = 0;
      const prefix = settings.invoicePrefix;

      for (const inv of allInv) {
        if (!inv || !inv.invoiceNumber) continue;
        if (typeof inv.invoiceNumber !== 'string') continue;

        if (inv.invoiceNumber.startsWith(prefix)) {
          const tail = inv.invoiceNumber.slice(prefix.length).replace(/^0+/, '') || '0';
          const n = Number(tail);
          if (!isNaN(n) && n > maxSeq) maxSeq = n;
        } else {
          const match = inv.invoiceNumber.match(/(\d+)$/);
          if (match) {
            const n = Number(match[1]);
            if (!isNaN(n) && n > maxSeq) maxSeq = n;
          }
        }
      }

      const seqRec = await db.settings.get('invoice_seq');
      const seqFromDB = (seqRec && typeof seqRec.value !== 'undefined')
        ? Number(seqRec.value)
        : (settings.invoiceSeq || 1);

      const next = Math.max(maxSeq + 1, seqFromDB);

      await db.settings.put({ key: 'invoice_seq', value: next + 1 });
      await db.settings.put({ key: 'global', value: settings });

      return `${settings.invoicePrefix}${String(next).padStart(5, '0')}`;
    }

    // =============== Logout ===============
    (function(){
      const logoutBtn = document.getElementById('logoutBtn');
      if(logoutBtn){
        logoutBtn.addEventListener('click', async function(){
          try { localStorage.removeItem('loggedInUser'); sessionStorage.removeItem('loggedInUser'); } catch(e){}
          try { const d = new Dexie('InvoiceDB'); await d.open().catch(()=>null); if(d && d.settings) await d.settings.delete('session').catch(()=>null); } catch(e){}
          window.location.href = 'login.html';
        });
      }
    })();

    // =============== Init ===============
    (async function init(){
      await ensureSeed();
      await loadSettings();
      try{ await renderUsersTable(); }catch(e){}
      issueDateEl.value = new Date().toISOString().slice(0,10);
      invoiceNoEl.value = await peekNextInvoiceNumber();
      lines = [{productId:'',description:'',size:'',rate:0,qty:1,amount:0}];
      products = await db.products.toArray().catch(()=>[]);
      renderProductsTable(); renderLines(); calcTotals();
      setTimeout(()=> { autoGrowTextarea(prodDescEl); autoGrowTextarea(customerEl); }, 60);

      openDbFileBtn.addEventListener('click', pickDatabaseFile);
      saveDbFileBtn.addEventListener('click', writeToDatabaseFile);
    })();

// ================= EXPORT / IMPORT JSON =================


if (exportDataBtn && importDataBtn && importFileInput) {
  // ✅ EXPORT
  exportDataBtn.addEventListener('click', async () => {
    try {
      const [products, customers, invoices, users, settings] = await Promise.all([
        db.products?.toArray() || [],
        db.customers?.toArray() || [],
        db.invoices?.toArray() || [],
        db.users?.toArray() || [],
        db.settings?.toArray() || []
      ]);

      const data = {
        meta: {
          exportedAt: new Date().toISOString(),
          app: 'Invoice Generator — Ranjan',
          version: '2.5'
        },
        products,
        customers,
        invoices,
        users,
        settings
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `invoice_backup_${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      alert('✅ Data exported successfully!');
    } catch (err) {
      console.error(err);
      alert('❌ Export failed: ' + err.message);
    }
  });

  // ✅ IMPORT
  importDataBtn.addEventListener('click', () => importFileInput.click());

  importFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);

      if (!confirm('⚠️ This will overwrite all existing data. Continue?')) return;

      // Clear tables first
      await Promise.all([
        db.products.clear(),
        db.customers.clear(),
        db.invoices.clear(),
        db.users.clear(),
        db.settings.clear()
      ]);

      // Restore from backup
      if (data.products) await db.products.bulkPut(data.products);
      if (data.customers) await db.customers.bulkPut(data.customers);
      if (data.invoices) await db.invoices.bulkPut(data.invoices);
      if (data.users) await db.users.bulkPut(data.users);
      if (data.settings) await db.settings.bulkPut(data.settings);

      alert('✅ Import completed successfully! Reloading...');
      location.reload();
    } catch (err) {
      console.error(err);
      alert('❌ Import failed: ' + err.message);
    }
  });
}

  </script>
</body>
</html>
