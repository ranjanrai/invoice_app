<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Invoice Generator — Mobile Friendly (Updated)</title>
  <!-- AUTH CHECK: place this near top of invoice.html (right after <body>) -->
<script>
  (function(){
    // require login: prefer localStorage (remember) else sessionStorage
    try {
      const user = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
      if(!user){
        // not logged in -> redirect to login
        const current = window.location.pathname.split('/').pop() || 'invoice.html';
        // pass referrer to login so it can redirect back if needed (optional)
        window.location.href = 'login.html?next=' + encodeURIComponent(current);
      } else {
        // optional: expose current user to page
        window.__LOGGED_IN_USER = user;
      }
    } catch(e){
      // best-effort fallback: redirect
      window.location.href = 'login.html';
    }
  })();
</script>

  <style>
    :root{--muted:#6b7280;--accent:#0b5ed7;--bg:#f3f4f6}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:14px;color:#111;-webkit-font-smoothing:antialiased}
    .app{max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px;font-size:18px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .controls button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px}
    .controls .primary{background:#0b5ed7}
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:8px;width:100%;font-size:14px}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .table-wrap{overflow:auto;border-radius:8px;background:#fff;padding:8px;border:1px solid #e6e6e6}
    .lines-table{width:100%;border-collapse:collapse;font-size:13px;min-width:900px}
    .lines-table th,.lines-table td{border:1px solid #111;padding:8px}
    .lines-table th{background:#fff;font-weight:700}
    .summary{max-width:360px;margin-left:auto;border-left:0}
    .summary .row-item{display:flex;justify-content:space-between;padding:6px 0}
    .summary .total{font-weight:700;font-size:18px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);Display:flex;align-items:flex-start;justify-content:center;padding:20px;z-index:40}
    .modal-content{background:#fff;padding:18px;border-radius:10px;width:100%;max-width:980px;max-height:90vh;overflow:auto}
    .hidden{display:none}
    .products-table{width:100%;border-collapse:collapse;margin-top:8px}
    .products-table th,.products-table td{border:1px solid #ddd;padding:6px}
    .invoice-print{width:842px;min-height:1191px;background:#fff;padding:28px;font-size:13px;color:#111}
    .inv-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:12px}
    .inv-col{flex:1;min-width:140px}
    .big-inv{font-size:18px;font-weight:800;letter-spacing:0.5px}
    .bill-to{margin-top:6px; white-space:pre-line}
    .logo{width:120px;height:auto;object-fit:contain;margin:0 auto;display:block}
    .lines-table-print{width:100%;border-collapse:collapse;border:1px solid #000;font-size:12px}
    .lines-table-print th,.lines-table-print td{border:1px solid #000;padding:6px}
    .totals-table{width:320px;border-collapse:collapse}
    .totals-table td{padding:4px}
    .totals-table .label{width:60%}
    @media (max-width:900px){.row{grid-template-columns:repeat(2,1fr)}.controls{flex-direction:column}.controls button{width:100%}.lines-table{min-width:700px}.modal-content{height:100vh;max-width:100%;border-radius:0;padding:12px}.invoice-print{width:100%;min-height:auto;padding:18px}.summary{max-width:100%;margin-left:0}.inv-header{flex-direction:row}}@media (max-width:600px){h1{font-size:16px}.inv-header{flex-direction:column;align-items:flex-start;gap:8px}.inv-right{width:100%;text-align:left}.inv-center{order:2}.big-inv{font-size:16px}.lines-table{min-width:600px}.row{grid-template-columns:1fr}}button{touch-action:manipulation}
/* small utility for action buttons */
.action-btn{border-radius:6px;padding:6px 8px;border:1px solid #ddd;background:#fff;cursor:pointer;margin-left:4px}
.action-btn.small{padding:4px 8px;font-weight:700}
/* Customer select plus inline add */
.customer-row{display:flex;gap:8px;align-items:center}
.customer-select{flex:1}
/* Preview/Printable Bill-To styling */
.inv-left .invoice-number { color:#6b6b6b; font-size:12px; }
.inv-left .big-inv { font-size:18px; font-weight:800; margin-top:4px; }
.inv-left .bill-title { margin-top:8px; font-weight:700; font-size:14px; letter-spacing:0.4px; }
.inv-left .bill-to { margin-top:6px; font-size:13px; line-height:1.25; color:#111; white-space:pre-line; }
.inv-left { max-width:360px; }
/* styles for preview mode scaling */
.preview-controls{display:flex;gap:12px;align-items:center;margin-bottom:10px}
.preview-wrapper{overflow:auto;border:1px solid #e6e6e6;padding:10px;background:#fafafa;display:flex;justify-content:center}
.preview-scaler{transition:transform .18s ease;transform-origin:top left;}
.preview-mode-mobile .preview-scaler{transform:scale(0.45);} /* on-screen visual scale for mobile-fit mode */
.preview-mode-desktop .preview-scaler{transform:scale(1);}
/* ====== FIX: ensure prodDesc visible + accessible ====== */
#prodDesc { min-height: 56px; line-height: 1.25; color: #111; background: #fff; resize: none; overflow: hidden; -webkit-text-size-adjust: 100%; box-shadow: none; display: block; width: 100%; }
  .invoice-print { position: relative; }

/* bottom-left company details inside preview */
.preview-company {
  position: absolute;
  left: 28px;
  bottom: 28px;
  max-width: 48%;
  background: rgba(255,255,255,0.00); /* keep transparent for PDF */
  padding: 4px 0;
  line-height: 1.3;
  color: #111;
  font-size: 13px;
}

/* bottom-right totals inside preview */
/* changed: avoid absolute positioning and make it sit to the right below the table for predictable PDF capture */
.preview-totals {
  position: static;        /* avoid absolute positioning for predictable PDF capture */
  display: block;
  margin-top: 8px;
  margin-left: auto;       /* pushes the block to the right inside its flex/parent container */
  width: 340px;            /* fixed width for consistent look */
  max-width: 90%;          /* responsive fallback on small screens */
  text-align: right;       /* align numbers to the right */
  box-sizing: border-box;
}

/* keep table compact within the wrapper */
.preview-totals .totals-table {
  margin: 0;
  width: 100%;
  border-collapse: collapse;
}

/* mobile tweak */
@media (max-width:600px){
  .preview-totals { width: 290px; max-width: 100%; margin-left: auto; margin-right: 0; }
}

/* small visual indicator in preview when high-quality export is enabled */
.hq-indicator { font-size:12px; color:#0b5ed7; margin-left:8px; font-weight:700; }
  </style>

</head>
<body>
  <div class="app">
    <h1>Invoice Generator — Mobile Friendly (Made by Ranjan Ray)</h1>

    <div class="controls">
      <button id="addLineBtn" class="primary">Add Line (+)</button>
      <button id="openSettingsBtn">Settings</button>
      <button id="previewBtn">Preview</button>
      <button id="saveBtn">Save (Offline)</button>
 

      <!-- New: persistent DB file controls -->
      <button id="openDbFileBtn" class="secondary">Open DB File</button>
      <button id="saveDbFileBtn" class="secondary">Save to DB File</button>

      <button id="exportDataBtn">Export Data (JSON)</button>
      <button id="importDataBtn">Import Data (JSON)</button>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
        <button id="logoutBtn" style="background:#fff;border:1px solid #ddd;color:#0b5ed7">Logout</button>

    </div>

    <!-- Arranged in a single line: Invoice, Date, Customer dropdown, User Name -->
    <div class="row">
      <div>
        <label>Invoice Number</label>
        <input id="invoiceNo" readonly />
      </div>
      <div>
        <label>Issue Date</label>
        <input id="issueDate" type="date" />
      </div>
      <div>
        <label style="font-weight:700; font-size:14px; margin-bottom:6px; display:block">Customer / Bill To</label>
        <div class="customer-row">
          <select id="customerSelect" class="customer-select"></select>
          <button id="addCustomerBtn" class="action-btn small">+</button>
          <button id="manageCustomersBtn" class="action-btn small">Manage</button>
        </div>
        <!-- now multiline customer details on main page -->
        <textarea id="customerName" placeholder="Customer name / address (multiline supported)" rows="3" style="margin-top:8px;padding:10px;border:1px solid #ddd;border-radius:6px;width:100%;font-family:inherit;font-size:14px;line-height:1.2;resize:vertical"></textarea>
      </div>
      <div>
        <label>User Name</label>
        <input id="userName" placeholder="Enter user / prepared by" />
      </div>
    </div>

    <div class="table-wrap">
      <table class="lines-table" id="linesTable">
        <thead>
          <tr>
            <th style="width:40px">Sl. No.</th>
            <th>Product Description</th>
            <th style="width:100px">Size</th>
            <th style="width:110px">Rate</th>
            <th style="width:90px">Quantity</th>
            <th style="width:110px">Amount</th>
            <th style="width:80px">Action</th>
          </tr>
        </thead>
        <tbody id="linesBody"></tbody>
      </table>
    </div>

    <!-- NOTE: company block removed from main UI per request; company details live in Preview bottom-left -->

    <div style="display:flex;gap:12px;margin-top:12px;align-items:flex-start;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
      <div id="companyName" style="font-weight:700;margin-bottom:6px">M/s BONE CARE SURGICALS</div>
        <div id="companyReg">18CXXPS2640JIZN</div>
        <div id="companyAddress">Rupnagar, Kamrup Metropolitan, Assam, 781032</div>
        <div id="companyEmail">bonecares@gmail.com</div>
        <div class="bank-info" style="margin-top:8px">
          <div>A/C: <span id="bankAcc">XXXXXX</span></div>
          <div>IFSC: <span id="bankIfsc">IDIB0000XXX</span></div>
          <div>BANK: <span id="bankName">INDIAN BANK</span> | BRANCH: <span id="bankBranch">GUWAHATI</span></div>
        </div>

      </div>

      <div class="summary" id="summaryBox" style="min-width:220px">
        <div class="row-item"><span>Sub Total</span><span id="subTotal">0.00</span></div>
           <div class="row-item"><span>Spl Discount (-)</span><span id="splDiscount">0.00</span></div> 
        <div class="row-item"><span>P & F Charges</span><span id="pfCharges">0.00</span></div>
        <div class="row-item"><span>GST @ <span id="gstPercentTxt">5</span>%</span><span id="gstAmount">0.00</span></div>
        <hr />
        <div class="row-item total"><span>Total</span><span id="totalAmount">0.00</span></div>
      </div>
    </div>

    <!-- Settings modal (full-screen on mobile) -->
    <div id="settingsModal" class="modal hidden">
      <div class="modal-content">
        <h3>Settings</h3>

        <h4>Company Details</h4>
        <div class="row">
          <div>
            <label>Company Name</label>
            <input id="companyNameInput" />
          </div>
          <div>
            <label>Registration/ GST / PAN</label>
            <input id="companyRegInput" />
          </div>
          <div>
            <label>Logo (URL or upload)</label>
            <input id="logoUrl" placeholder="logo.png or https://..." />
            <input id="logoFile" type="file" accept="image/*" />
            <div style="font-size:12px;color:#666;margin-top:6px">Upload a high-resolution logo (PNG/JPEG). If the file is extremely large it will be downscaled slightly to avoid memory issues while keeping HD appearance in PDFs.</div>
          </div>
        </div>

        <div class="row" style="align-items:center">
          <div style="display:flex;align-items:center;gap:8px">
            <input id="showLogo" type="checkbox" />
            <label for="showLogo" style="margin:0">Show logo in invoice preview / PDF</label>
          </div>
          <div>
            <label>Logo width (px)</label>
            <input id="logoWidth" type="number" min="40" max="1200" placeholder="120" />
          </div>
          <div></div>
        </div>

        <div class="row">
          <div>
            <label>Address</label>
            <textarea id="companyAddressInput" rows="2"></textarea>
          </div>
          <div>
            <label>Email</label>
            <input id="companyEmailInput" />
          </div>
          <div>
            <label>Bank Account</label>
            <input id="bankAccInput" placeholder="Account number" />
            <label style="margin-top:6px">IFSC</label>
            <input id="bankIfscInput" placeholder="IFSC code" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:140px">
            <label>Bank Name</label>
            <input id="bankNameInput" />
          </div>
          <div style="flex:1;min-width:140px">
            <label>Bank Branch</label>
            <input id="bankBranchInput" />
          </div>
          <div style="flex:1;min-width:120px">
            <label>GST Percent</label>
            <input id="gstPercent" type="number" value="5" />
          </div>
        </div>

        <!-- Invoice numbering controls (Settings) -->
        <div class="row" style="align-items:center;gap:8px;margin-top:12px">
          <div>
            <label>Invoice Prefix</label>
            <input id="invoicePrefix" placeholder="INV-2025-" />
          </div>
          <div>
            <label>Invoice Seq (numeric)</label>
            <input id="invoiceSeq" type="number" min="1" />
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button id="applyInvoiceNumberBtn">Apply Invoice Number</button>
          </div>
        </div>
        <div style="font-size:12px;color:#666;margin-top:6px">
          Use <strong>Apply Invoice Number</strong> to set the invoice shown in the editor without increasing the stored sequence. The sequence will advance only when you export the PDF.
        </div>

        <hr style="margin:12px 0" />

        <!-- Customer management inside settings: multiline textarea for name -->
        <h4>Customers</h4>
        <div style="display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1;min-width:260px">
            <label style="display:block;margin-bottom:6px;font-size:12px;color:var(--muted)">Add / Edit Customer (multiline allowed)</label>
            <textarea id="custName" placeholder="Customer name / address (use new lines)" rows="3" style="width:100%"></textarea>
            <div style="margin-top:8px"><button id="saveCustomerBtn">Save Customer</button></div>
          </div>

          <div style="flex:1;min-width:260px;overflow:auto;max-height:240px">
            <table class="products-table" id="customersTable">
              <thead><tr><th>#</th><th>Name</th><th>Action</th></tr></thead>
              <tbody id="customersBody"></tbody>
            </table>
          </div>
        </div>

        <hr style="margin:12px 0" />

        <h4>Products</h4>
        <div style="display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap">
          <!-- Changed to textarea with auto-grow and multiline support -->
          <div style="flex:1;min-width:160px">
            <label style="display:block;margin-bottom:6px;font-size:12px;color:var(--muted)">Description</label>
            <textarea id="prodDesc" placeholder="Product description (supports multiple lines)" rows="2"></textarea>
          </div>

          <div style="width:120px;min-width:120px">
            <label style="display:block;margin-bottom:6px;font-size:12px;color:var(--muted)">Size</label>
            <input id="prodSize" placeholder="Size" style="width:100%" />
          </div>

          <div style="width:120px;min-width:120px">
            <label style="display:block;margin-bottom:6px;font-size:12px;color:var(--muted)">Rate</label>
            <input id="prodRate" placeholder="Rate" type="number" style="width:100%" />
          </div>

          <div style="display:flex;align-items:flex-end">
            <button id="addProdBtn">Add Product</button>
          </div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table class="products-table" id="productsTable">
            <thead><tr><th>#</th><th>Description</th><th>Size</th><th>Rate</th><th>Action</th></tr></thead>
            <tbody id="productsBody"></tbody>
          </table>
        </div>

        <hr style="margin:12px 0" />

        <h4>Other Settings</h4>
        <!-- ===== Application Login (stored locally) ===== -->
<h4>Application Login</h4>
<div class="row" style="align-items:center">
  <div>
    <label>Username</label>
    <input id="authUsername" placeholder="admin" />
  </div>
  <div>
    <label>Password</label>
    <input id="authPassword" type="password" placeholder="admin123" />
  </div>
  <div style="display:flex;align-items:flex-end;gap:8px">
    <button id="saveAuthBtn">Add User</button>
    <button id="resetAuthBtn" class="action-btn small">Reset to default</button>
  </div>
</div>

<!-- users list -->
<div style="margin-top:12px">
  <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Existing users</div>
  <table class="products-table" id="usersTable">
    <thead><tr><th>#</th><th>Username</th><th>Action</th></tr></thead>
    <tbody id="usersBody"></tbody>
  </table>
</div>

        <div class="row">
          <div>
            <label>Discount Type</label>
            <select id="discountType"><option value="percent">Percent</option><option value="amount">Flat</option></select>
          </div>
          <div>
            <label>Discount Value</label>
            <input id="discountValue" type="number" />
          </div>
          <div>
            <label>P & F Charges</label>
            <input id="pfValue" type="number" />
          </div>
        </div>

        <hr style="margin:12px 0" />

        <h4>PDF Export & Compression</h4>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="flex:1;min-width:180px">
            <label>PDF Quality (image compression)</label>
            <input id="pdfQuality" type="range" min="0.1" max="1" step="0.05" value="0.8" />
            <div style="font-size:12px;color:#666;margin-top:6px">Lower = smaller PDF. Try 0.6–0.8 for good balance on phones.</div>
          </div>
          <div style="min-width:180px">
            <label style="display:block">Compress images as JPEG</label>
            <input id="compressJpeg" type="checkbox" /> Use JPEG to reduce size (recommended)
          </div>
        </div>

        <!-- NEW: High Quality PDF option: checkbox + enable/disable button -->
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:8px">
            <input id="highQualityPdf" type="checkbox" />
            <label for="highQualityPdf" style="margin:0">High Quality PDF (lossless, larger file)</label>
            <span id="hqIndicatorPreview" class="hq-indicator hidden">HQ ON</span>
          </div>
          <div>
            <button id="toggleHighQualityBtn" class="action-btn small">Enable High Quality</button>
          </div>
          <div style="font-size:12px;color:#666;flex:1">
            When enabled the export uses higher capture scale and lossless PNG (bigger files) for crisp prints. Use when you need sharp text/graphics.
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button id="saveSettings">Save</button>
          <button id="closeSettings">Close</button>
        </div>
      </div>
    </div>

    <!-- Preview / Printable Modal -->
    <div id="previewModal" class="modal hidden">
      <div class="modal-content">
        <!-- NEW: Preview mode controls (Desktop / Mobile-fit) -->
        <div class="preview-controls">
          <label style="margin-right:6px;font-weight:700">Preview Mode:</label>
          <label><input type="radio" name="previewMode" value="desktop" checked /> Desktop</label>
          <label><input type="radio" name="previewMode" value="mobile" style="margin-left:8px" /> Mobile-fit (small)</label>
          <div style="margin-left:auto;font-size:12px;color:#666">Mobile-fit shows the desktop layout scaled down to fit phone screens and exports a smaller visual PDF.</div>
        </div>

        <div class="preview-wrapper preview-mode-desktop" id="previewWrapper">
          <div class="preview-scaler" id="previewScaler">
            <div id="previewArea" class="invoice-print">
              <!-- Logo placed at very top center (will be honored in PDF export) -->
              <div style="text-align:center;margin-bottom:12px;">
                <img id="printLogo" class="logo" src="" alt="logo" />
              </div>

              <!-- Modified header: Invoice No | Issue Date | Bill To | User (single row) -->
              <div class="inv-header">
                <div class="inv-col">
                  <div class="invoice-number" style="color:var(--muted);font-size:12px">INVOICE NUMBER</div>
                  <div class="big-inv" id="printInvoiceNo">INV-2025-00003</div>
                </div>

                <div class="inv-col">
                  <div style="color:var(--muted);font-size:12px">ISSUE DATE</div>
                  <div id="printDate" style="font-weight:700"></div>
                </div>

                <div class="inv-col">
                  <div class="bill-title">BILL TO</div>
                  <div class="bill-to" id="printBillTo"></div>
                </div>

                <div class="inv-col">
                  <div style="color:var(--muted);font-size:12px">PREPARED BY</div>
                  <div id="printUserName" style="font-weight:700"></div>
                </div>
              </div>

              <div class="table-wrap-print">
                <table class="lines-table-print" id="printLines">
                  <thead>
                    <tr>
                      <th style="width:40px">Sl. No.</th>
                      <th>Product Description</th>
                      <th style="width:100px">Size</th>
                      <th style="width:110px">Rate</th>
                      <th style="width:90px">Quantity</th>
                      <th style="width:110px">Amount</th>
                    </tr>
                  </thead>
                  <tbody id="printLinesBody"></tbody>
                </table>
              </div>

              <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:8px;flex-wrap:wrap">
                <div style="width:100%;max-width:480px">
                  <div class="preview-company" id="previewCompanyBlock">
  <div id="printCompanyName" style="font-weight:700;margin-bottom:4px">M/s BONE CARE SURGICALS</div>
  <div id="printCompanyReg">18CXXPS2640JIZN</div>
  <div id="printCompanyAddr">Rupnagar, Kamrup Metropolitan, Assam, 781032</div>
  <div id="printCompanyEmail">bonecares@gmail.com</div>
  <div style="margin-top:6px;font-size:13px">A/C: <span id="printBankAcc"></span> &nbsp; IFSC: <span id="printBankIfsc"></span></div>
</div>
                </div>

                
                  <div class="preview-totals">
 <table class="totals-table" style="background:#fff;border:1px solid #e6e6e6;padding:10px;border-radius:6px;width:100%;">
    <tr><td class="label">Sub Total</td><td id="pSubTotal" style="text-align:right">0.00</td></tr>
    <tr><td class="label">Spl Discount (-)</td><td id="pDiscount" style="text-align:right">0.00</td></tr>
    <tr><td class="label">P & F Charges</td><td id="pPF" style="text-align:right">0.00</td></tr>
    <tr><td class="label">GST @ <span id="pGSTPercent">5</span>%</td><td id="pGST" style="text-align:right">0.00</td></tr>
    <tr><td class="label total">Total</td><td id="pTotal" style="text-align:right;font-weight:700">0.00</td></tr>
  </table>
</div>
                
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
          <button id="exportPdfBtn">Export to PDF</button>
          <button id="closePreviewBtn">Close</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Libraries: Dexie for IndexedDB + html2canvas + jspdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Offline-first DB
    const db = new Dexie('InvoiceDB');
    // add a users store for multi-user auth
    db.version(1).stores({
      products: 'id,name,size,rate,description',
      settings: 'key',
      invoices: '++id,invoiceNumber,createdAt'
    });
    try {
      db.version(2).stores({ customers: 'id,name' });
    } catch (e) {}

    // add users store in a later version (safe if DB already exists)
    try {
      db.version(3).stores({ users: '++id,username' });
    } catch(e){}

    // --- new: File System Access API persistent handle + utilities ---
    let persistedFileHandle = null; // holds a file handle when the user opens a db.json via FS API

    async function sha256hex(text){
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function pickDatabaseFile(){
      if(!window.showOpenFilePicker){
        alert('File System Access API not available in this browser. Use Export/Import instead.');
        // fallback: trigger regular import flow
        document.getElementById('importFile').click();
        return;
      }
      try {
        const [handle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
          excludeAcceptAllOption: false
        });
        persistedFileHandle = handle;
        const file = await handle.getFile();
        const text = await file.text();
        const obj = JSON.parse(text);
        await importDataFromObject(obj);
        alert('Database file opened and imported from disk.');
      } catch(err){
        if(err.name !== 'AbortError') console.warn('pickDatabaseFile:', err);
      }
    }

    async function writeToDatabaseFile(){
      if(!persistedFileHandle){
        alert('No database file opened. Click "Open DB File" first or use Export Data (JSON).');
        return;
      }
      try {
        const snapshot = await createDbSnapshot();
        const writable = await persistedFileHandle.createWritable();
        await writable.write(JSON.stringify(snapshot, null, 2));
        await writable.close();
        alert('Saved DB to opened file.');
      } catch(err){
        console.error('writeToDatabaseFile', err);
        alert('Save to file failed: ' + (err.message || err));
      }
    }

    async function tryAutoSaveToHandle(){
      if(!persistedFileHandle) return;
      try{ await writeToDatabaseFile(); }catch(e){ console.warn('autosave failed', e); }
    }

    async function createDbSnapshot(){
      const [productsArr, settingsArr, invoicesArr, customersArr, usersArr] = await Promise.all([
        db.products.toArray().catch(()=>[]),
        db.settings.toArray().catch(()=>[]),
        db.invoices.toArray().catch(()=>[]),
        (db.customers ? db.customers.toArray().catch(()=>[]) : Promise.resolve([])),
        (db.users ? db.users.toArray().catch(()=>[]) : Promise.resolve([]))
      ]);
      const seq = (await db.settings.get('invoice_seq')) || { key:'invoice_seq', value: (settings.invoiceSeq || 1) };
      return {
        meta:{ exportedAt: new Date().toISOString(), source:'InvoiceApp' },
        products: productsArr,
        settings: settingsArr,
        invoices: invoicesArr,
        customers: customersArr,
        users: usersArr,
        counters: { invoice_seq: seq.value || 0 }
      };
    }

    // --- elements (same as before) ---
    const invoiceNoEl = document.getElementById('invoiceNo');
    const issueDateEl = document.getElementById('issueDate');
    const customerEl = document.getElementById('customerName'); // now textarea multiline
    const customerSelect = document.getElementById('customerSelect');
    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const manageCustomersBtn = document.getElementById('manageCustomersBtn');
    const linesBody = document.getElementById('linesBody');
    const addLineBtn = document.getElementById('addLineBtn');
    const openSettingsBtn = document.getElementById('openSettingsBtn');
    const previewBtn = document.getElementById('previewBtn');
    const saveBtn = document.getElementById('saveBtn');
    const exportAllBtn = document.getElementById('exportAllBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const importFileInput = document.getElementById('importFile');
    const userNameEl = document.getElementById('userName');

    // summary fields
    const subTotalEl = document.getElementById('subTotal');
    const pfChargesEl = document.getElementById('pfCharges');
    const gstAmountEl = document.getElementById('gstAmount');
    const totalAmountEl = document.getElementById('totalAmount');
    const gstPercentTxt = document.getElementById('gstPercentTxt');

    // settings modal elements
    const settingsModal = document.getElementById('settingsModal');
    const discountTypeEl = document.getElementById('discountType');
    const discountValueEl = document.getElementById('discountValue');
    const pfValueEl = document.getElementById('pfValue');
    const gstPercentEl = document.getElementById('gstPercent');
    const logoUrlEl = document.getElementById('logoUrl');
    const logoFileEl = document.getElementById('logoFile');
    const showLogoEl = document.getElementById('showLogo');
    // ✅ Remember uploaded logo as Base64
logoFileEl.addEventListener('change', function(){
  const file = logoFileEl.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    settings.logoData = e.target.result; // store base64
    logoUrlEl.value = ""; // clear URL if file used
    printLogo.src = settings.logoData;
    showLogoEl.checked = true;
    applyLogoVisibility();
  };
  reader.readAsDataURL(file);
});

    const logoWidthEl = document.getElementById('logoWidth');
    const bankAccInput = document.getElementById('bankAccInput');
    const bankIfscInput = document.getElementById('bankIfscInput');
    const bankNameInput = document.getElementById('bankNameInput');
    const bankBranchInput = document.getElementById('bankBranchInput');
    const companyNameInput = document.getElementById('companyNameInput');
    const companyRegInput = document.getElementById('companyRegInput');
    const companyAddressInput = document.getElementById('companyAddressInput');
    const companyEmailInput = document.getElementById('companyEmailInput');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const closeSettingsBtn = document.getElementById('closeSettings');
    // --- Auth elements (multi-user) ---
    const authUsernameEl = document.getElementById('authUsername');
    const authPasswordEl = document.getElementById('authPassword');
    const saveAuthBtn = document.getElementById('saveAuthBtn');
    const resetAuthBtn = document.getElementById('resetAuthBtn');
    const usersBodyEl = document.getElementById('usersBody');

    // invoice numbering inputs (now present in Settings)
    const invoicePrefixEl = document.getElementById('invoicePrefix');
    const invoiceSeqEl = document.getElementById('invoiceSeq');
    const applyInvoiceNumberBtn = document.getElementById('applyInvoiceNumberBtn');

    // product elements
    const prodDescEl = document.getElementById('prodDesc');
    const prodSizeEl = document.getElementById('prodSize');
    const prodRateEl = document.getElementById('prodRate');
    const addProdBtn = document.getElementById('addProdBtn');
    const productsBody = document.getElementById('productsBody');

    // customer settings elements
    const customersBody = document.getElementById('customersBody');
    const custNameEl = document.getElementById('custName');
    const saveCustomerBtn = document.getElementById('saveCustomerBtn');

    // preview elements
    const previewModal = document.getElementById('previewModal');
    const printInvoiceNo = document.getElementById('printInvoiceNo');
    const printBillTo = document.getElementById('printBillTo');
    const printDate = document.getElementById('printDate');
    const printLinesBody = document.getElementById('printLinesBody');
    const printLogo = document.getElementById('printLogo');
    const pSubTotal = document.getElementById('pSubTotal');
    const pDiscount = document.getElementById('pDiscount');
    const pPF = document.getElementById('pPF');
    const pGST = document.getElementById('pGST');
    const pTotal = document.getElementById('pTotal');
    const pGSTPercent = document.getElementById('pGSTPercent');
    const printCompanyName = document.getElementById('printCompanyName');
    const printCompanyReg = document.getElementById('printCompanyReg');
    const printCompanyAddr = document.getElementById('printCompanyAddr');
    const printCompanyEmail = document.getElementById('printCompanyEmail');
    const printBankAcc = document.getElementById('printBankAcc');
    const printBankIfsc = document.getElementById('printBankIfsc');
    const printUserName = document.getElementById('printUserName');
    const hqCheckbox = document.getElementById('highQualityPdf');
    const toggleHighQualityBtn = document.getElementById('toggleHighQualityBtn');
    const hqIndicatorPreview = document.getElementById('hqIndicatorPreview');

    const exportPdfBtn = document.getElementById('exportPdfBtn');

    const closePreviewBtn = document.getElementById('closePreviewBtn');

    const previewWrapper = document.getElementById('previewWrapper');
    const previewScaler = document.getElementById('previewScaler');

    // pdf settings UI
    const pdfQualityEl = document.getElementById('pdfQuality');
    const compressJpegEl = document.getElementById('compressJpeg');

    // local state
    let products = [];
    let lines = [];
    let customers = [];
    let settings = {
      splDiscountType:'percent', splDiscountValue:0, pfCharges:0, gstPercent:5,
      logoUrl:'', logoData:'', showLogo:true, logoWidth:120,
      bankAcc:'XXXXXX', bankIfsc:'IDIB0000018', bankName:'INDIAN BANK',
      bankBranch:'GUWAHATI', companyName:'M/s BONE CARE SURGICALS',
      companyReg:'18CXXPS2640JIZN', companyAddress:'Rupnagar, Kamrup Metropolitan, Assam, 781032',
      companyEmail:'bonecares@gmail.com', invoicePrefix:`INV-${new Date().getFullYear()}-`, invoiceSeq:1,
      pdfQuality:0.8, compressJpeg:true,
      highQualityPdf:false // NEW default
    };

    // sample products
    const sampleProducts = [
      { id:cryptoRandomId(), name:'DHL MEDIAL LOCKING PLATE 3.5MM (RIGHT)', size:'5 Hole', rate:4400, description:'DHL MEDIAL LOCKING PLATE 3.5MM (RIGHT)' },
      { id:cryptoRandomId(), name:'RECONSTRUCTION PLATE 3.5MM WITH LOCKING SYSTEM', size:'7 HOLE', rate:1400, description:'RECONSTRUCTION PLATE' },
      { id:cryptoRandomId(), name:'CANNULATED CANNELLOUS SCREW XL DIA 4.0 mm', size:'30 MM', rate:700, description:'CANNULATED SCREW' },
      { id:cryptoRandomId(), name:'One - Third Tubular Plate 3.5mm', size:'5 HOLE', rate:2200, description:'One-Third Tubular Plate' }
    ];

    function cryptoRandomId(){ return 'id_'+Math.random().toString(36).slice(2,9); }
    function fmt(v){return Number(v||0).toFixed(2)}
    function autoGrowTextarea(el){ if(!el) return; el.style.height='auto'; el.style.height=(el.scrollHeight)+'px'; }

    // -------- users store helpers (multi-user) ----------
    async function addUser(username, passwordPlain){
      if(!username || !passwordPlain) throw new Error('username & password required');
      // ensure users table exists
      if(!db.users) throw new Error('Users store not available');
      const existing = await db.users.where('username').equals(username).first();
      if(existing) throw new Error('Username already exists');
      const hash = await sha256hex(passwordPlain);
      const id = await db.users.add({ username, passwordHash: hash, createdAt: new Date().toISOString() });
      await renderUsersTable();
      return id;
    }
    async function updateUser(id, username, passwordPlain){
      if(!db.users) throw new Error('Users store not available');
      const rec = { username };
      if(passwordPlain) rec.passwordHash = await sha256hex(passwordPlain);
      await db.users.update(id, rec);
      await renderUsersTable();
    }
    async function deleteUser(id){
      if(!db.users) throw new Error('Users store not available');
      await db.users.delete(id);
      await renderUsersTable();
    }
    async function listUsers(){
      if(!db.users) return [];
      return await db.users.toArray();
    }

    // render users table inside settings modal
    async function renderUsersTable(){
      const body = document.getElementById('usersBody');
      if(!body) return;
      const us = await listUsers().catch(()=>[]);
      body.innerHTML = '';
      us.forEach((u,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(u.username)}</td><td><button data-id="${u.id}" class="editUser">Edit</button> <button data-id="${u.id}" class="delUser">Delete</button></td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('.delUser').forEach(btn=> btn.addEventListener('click', async (e)=>{ if(!confirm('Delete this user?')) return; const id = Number(e.target.dataset.id); await deleteUser(id); await tryAutoSaveToHandle(); }));
      body.querySelectorAll('.editUser').forEach(btn=> btn.addEventListener('click', async (e)=>{ const id = Number(e.target.dataset.id); const rec = await db.users.get(id); if(!rec) return; authUsernameEl.value = rec.username || ''; authPasswordEl.value = ''; saveAuthBtn.textContent = 'Update User'; saveAuthBtn.dataset.edit = id; }));
    }

    // --------- seed default user if none -------------
    async function seedDefaultUserIfNeeded(){
      try{
        if(!db.users) return;
        const cnt = await db.users.count().catch(()=>0);
        if(!cnt){
          // try to migrate legacy settings.auth if present
          const legacy = await db.settings.get('auth').catch(()=>null);
          if(legacy && legacy.value && legacy.value.username){
            const pwd = legacy.value.password || '';
            if(pwd){
              const hashed = await sha256hex(pwd);
              await db.users.add({ username: legacy.value.username, passwordHash: hashed, createdAt: new Date().toISOString() }).catch(()=>{});
            } else if(legacy.value.passwordHash){
              await db.users.add({ username: legacy.value.username, passwordHash: legacy.value.passwordHash, createdAt: new Date().toISOString() }).catch(()=>{});
            }
          } else {
            // create default admin/admin123
            const hashed = await sha256hex('admin123');
            await db.users.add({ username:'admin', passwordHash: hashed, createdAt: new Date().toISOString() }).catch(()=>{});
          }
        }
      }catch(e){
        console.warn('seed users failed', e);
      }
    }

    async function ensureSeed(){
      const cnt = await db.products.count();
      if(cnt===0){ await db.products.bulkPut(sampleProducts); }
      products = await db.products.toArray();
      renderProductsTable();

      try{
        const ccount = await db.customers.count();
        if(ccount===0){
          const sampleCust = [{ id:cryptoRandomId(), name:'Walk-in Customer' }];
          await db.customers.bulkPut(sampleCust);
        }
        customers = await db.customers.toArray();
        renderCustomersTable();
        populateCustomerSelect();
      }catch(e){}
      // ensure users seeded
      try { await seedDefaultUserIfNeeded(); } catch(e){}
    }

    async function loadSettings(){
      const s = await db.settings.get('global');
      if(s && s.value) settings = Object.assign(settings, s.value);

      // reflect to inputs
      discountTypeEl.value = settings.splDiscountType;
      discountValueEl.value = settings.splDiscountValue;
      pfValueEl.value = settings.pfCharges;
      gstPercentEl.value = settings.gstPercent;
      logoUrlEl.value = settings.logoUrl || '';
      showLogoEl.checked = !!settings.showLogo;
      logoWidthEl.value = settings.logoWidth || 120;
      companyNameInput.value = settings.companyName || '';
      companyRegInput.value = settings.companyReg || '';
      companyAddressInput.value = settings.companyAddress || '';
      companyEmailInput.value = settings.companyEmail || '';
      bankAccInput.value = settings.bankAcc || '';
      bankIfscInput.value = settings.bankIfsc || '';
      bankNameInput.value = settings.bankName || '';
      bankBranchInput.value = settings.bankBranch || '';
      gstPercentTxt.textContent = settings.gstPercent;
      // populate auth fields (if present) — we keep legacy auth visible but do not use it as primary source
      try {
        const authRec = await db.settings.get('auth');
        const auth = authRec && authRec.value ? authRec.value : null;
        if(auth) {
          if(authUsernameEl) authUsernameEl.value = auth.username || '';
          // do NOT populate password field with hashed value; keep blank to force user to enter new password if changing
          if(authPasswordEl) authPasswordEl.value = '';
        } else {
          if(authUsernameEl) authUsernameEl.value = '';
          if(authPasswordEl) authPasswordEl.value = '';
        }
      } catch(e) {
        // ignore
      }

      // numbering reflection (show in settings inputs)
      if(invoicePrefixEl) invoicePrefixEl.value = settings.invoicePrefix || (`INV-${new Date().getFullYear()}-`);
      if(invoiceSeqEl) invoiceSeqEl.value = (typeof settings.invoiceSeq !== 'undefined') ? Number(settings.invoiceSeq) : (settings.invoiceSeq || 1);

      // update preview company fields
      document.getElementById('printCompanyName').textContent = settings.companyName;
      document.getElementById('printCompanyReg').textContent = settings.companyReg;
      document.getElementById('printCompanyAddr').textContent = settings.companyAddress;
      document.getElementById('printCompanyEmail').textContent = settings.companyEmail;
      document.getElementById('printBankAcc').textContent = settings.bankAcc;
      document.getElementById('printBankIfsc').textContent = settings.bankIfsc;

      // logo: pick data or url
      if(settings.logoData){ printLogo.src = settings.logoData; }
      else if(settings.logoUrl){ printLogo.src = settings.logoUrl; }
      else printLogo.src = '';

      // pdf settings reflect
      pdfQualityEl.value = (typeof settings.pdfQuality !== 'undefined') ? settings.pdfQuality : 0.8;
      compressJpegEl.checked = !!settings.compressJpeg;

      // high quality reflect
      if(hqCheckbox) hqCheckbox.checked = !!settings.highQualityPdf;
      updateHighQualityUi();

      applyLogoVisibility();
    }

    function applyLogoVisibility(){
      if(!printLogo) return;
      if(!settings.showLogo){ printLogo.style.display = 'none'; return; }
      // show only if we have a src
      if(settings.logoData || settings.logoUrl){
        printLogo.style.display = 'block';
        const w = Number(settings.logoWidth) || 120;
        printLogo.style.maxWidth = (w>0? w + 'px' : '120px');
        printLogo.style.width = (w>0? w + 'px' : 'auto');
        printLogo.style.height = 'auto';
      } else {
        printLogo.style.display = 'none';
      }
    }

    function renderProductsTable(){
      productsBody.innerHTML = '';
      products.forEach((p,i)=>{
        const tr = document.createElement('tr');
        const desc = escapeHtml(p.description || p.name || '');
        tr.innerHTML = `<td>${i+1}</td><td style="white-space:pre-line;max-width:420px">${desc}</td><td>${escapeHtml(p.size)}</td><td style='text-align:right'>${fmt(p.rate)}</td><td><button data-id='${p.id}' class='editProd'>Edit</button> <button data-id='${p.id}' class='delProd'>Delete</button></td>`;
        productsBody.appendChild(tr);
      });
      productsBody.querySelectorAll('.delProd').forEach(btn=> btn.addEventListener('click', async (e)=>{ const id = e.target.dataset.id; await db.products.delete(id); products = await db.products.toArray(); renderProductsTable(); renderLines(); calcTotals(); await tryAutoSaveToHandle(); }));
      productsBody.querySelectorAll('.editProd').forEach(btn=> btn.addEventListener('click', (e)=>{ const id = e.target.dataset.id; const p = products.find(x=>x.id===id); if(!p) return; prodDescEl.value = p.description || p.name || ''; prodSizeEl.value = p.size; prodRateEl.value = p.rate; addProdBtn.dataset.edit = id; addProdBtn.textContent='Update Product'; autoGrowTextarea(prodDescEl); }));
      setTimeout(()=> autoGrowTextarea(prodDescEl), 50);
    }

    function renderCustomersTable(){
      customersBody.innerHTML = '';
      customers.forEach((c,i)=>{
        const tr = document.createElement('tr');
        // show the first line in table for compactness but keep stored multiline
        const previewLine = (String(c.name||'').split('\n')[0]||'').replace(/\s+/g,' ').trim();
        tr.innerHTML = `<td>${i+1}</td><td style="white-space:pre-line;max-width:420px">${escapeHtml(previewLine)}</td><td><button data-id='${c.id}' class='editCust'>Edit</button> <button data-id='${c.id}' class='delCust'>Delete</button></td>`;
        customersBody.appendChild(tr);
      });
      customersBody.querySelectorAll('.delCust').forEach(btn=> btn.addEventListener('click', async (e)=>{ const id = e.target.dataset.id; await db.customers.delete(id); customers = await db.customers.toArray(); renderCustomersTable(); populateCustomerSelect(); await tryAutoSaveToHandle(); }));
      customersBody.querySelectorAll('.editCust').forEach(btn=> btn.addEventListener('click', (e)=>{ const id = e.target.dataset.id; const c = customers.find(x=>x.id===id); if(!c) return; custNameEl.value = c.name; saveCustomerBtn.dataset.edit = id; }));
    }

    function populateCustomerSelect(){
      customerSelect.innerHTML = '';
      const opt = document.createElement('option'); opt.value=''; opt.textContent='-- select customer --'; customerSelect.appendChild(opt);
      customers.forEach(c=>{
        const o = document.createElement('option'); o.value = c.id; o.textContent = (String(c.name||'').split('\n')[0]||'').replace(/\s+/g,' ').trim(); customerSelect.appendChild(o);
      });
      const addOpt = document.createElement('option'); addOpt.value = '__add__'; addOpt.textContent = 'Add new customer...'; customerSelect.appendChild(addOpt);
    }

    if(prodDescEl) { prodDescEl.addEventListener('input', () => autoGrowTextarea(prodDescEl)); prodDescEl.addEventListener('focus', () => autoGrowTextarea(prodDescEl)); }
    if(customerEl) { customerEl.addEventListener('input', () => autoGrowTextarea(customerEl)); }

    addProdBtn.addEventListener('click', async ()=>{
      const description = prodDescEl.value.trim();
      const name = (description.split('\n')[0]||description).trim();
      const size = prodSizeEl.value.trim(); const rate = Number(prodRateEl.value||0);
      if(!description) return alert('Enter product description');
      if(addProdBtn.dataset.edit){ const id = addProdBtn.dataset.edit; await db.products.update(id,{ description, name, size, rate }); delete addProdBtn.dataset.edit; addProdBtn.textContent='Add Product'; }
      else { const id = cryptoRandomId(); await db.products.put({ id, name, size, rate, description }); }
      prodDescEl.value=''; prodSizeEl.value=''; prodRateEl.value=''; products = await db.products.toArray(); renderProductsTable(); renderLines(); calcTotals(); autoGrowTextarea(prodDescEl);
      // autosave to file handle if open
      await tryAutoSaveToHandle();
    });

    // Customers: multiline textarea save
    saveCustomerBtn.addEventListener('click', async ()=>{
      const name = (custNameEl.value||'').trim();
      if(!name) return alert('Enter customer name (or multiline details)');
      if(saveCustomerBtn.dataset.edit){ const id = saveCustomerBtn.dataset.edit; await db.customers.update(id,{ name }); delete saveCustomerBtn.dataset.edit; saveCustomerBtn.textContent='Save Customer'; }
      else { const id = cryptoRandomId(); await db.customers.put({ id, name }); }
      custNameEl.value=''; customers = await db.customers.toArray(); renderCustomersTable(); populateCustomerSelect();
      await tryAutoSaveToHandle();
    });

    // Quick-add customer (prompt -> stores single-line)
    addCustomerBtn.addEventListener('click', async ()=>{
      const name = prompt('Customer name'); if(!name) return; const id = cryptoRandomId(); await db.customers.put({ id, name: name.trim() }); customers = await db.customers.toArray(); renderCustomersTable(); populateCustomerSelect();
      customerSelect.value = id; customerEl.value = name.trim(); autoGrowTextarea(customerEl);
      await tryAutoSaveToHandle();
    });

    manageCustomersBtn.addEventListener('click', ()=>{ openSettingsBtn.click(); setTimeout(()=>{ const el = document.getElementById('custName'); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}); },150); });

    customerSelect.addEventListener('change', (e)=>{
      const val = e.target.value;
      if(val === '__add__'){ addCustomerBtn.click(); return; }
      const c = customers.find(x=>x.id===val);
      if(c){ customerEl.value = c.name; autoGrowTextarea(customerEl); } else { customerEl.value = ''; }
    });

    function createLineRow(line, idx){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>
          <select class='prod-select'>
            <option value=''>-- select product --</option>
            ${products.map(p => `<option value='${p.id}' ${line.productId===p.id?'selected':''}>${escapeHtml((p.name||'').toString())}</option>`).join('')}
          </select>
          <div style='font-size:11px;color:#666;white-space:pre-line'>${escapeHtml(line.description||'')}</div>
        </td>
        <td class='size-cell'>${escapeHtml(line.size||'')}</td>
        <td><input class='rate-input' type='number' value='${line.rate||0}' /></td>
        <td><input class='qty-input' type='number' min='0' value='${line.qty||1}' /></td>
        <td class='amount-cell' style='text-align:right'>${fmt(line.amount)}</td>
        <td>
          <button class='action-btn small minus-btn' title='Remove line'>−</button>
          <button class='action-btn small plus-btn' title='Add line after'>+</button>
        </td>
      `;
      tr.querySelector('.prod-select').addEventListener('change', (e)=>{
        const pid = e.target.value; const p = products.find(x=>x.id===pid) || {};
        lines[idx].productId = pid;
        lines[idx].description = p.description || p.name || '';
        lines[idx].size = p.size || '';
        lines[idx].rate = Number(p.rate || 0);
        lines[idx].qty = Number(lines[idx].qty || 1);
        lines[idx].amount = lines[idx].rate * lines[idx].qty;
        renderLines(); calcTotals();
      });
      tr.querySelector('.rate-input').addEventListener('input', (e)=>{ lines[idx].rate = Number(e.target.value||0); lines[idx].amount = lines[idx].rate * lines[idx].qty; renderLines(); calcTotals(); });
      tr.querySelector('.qty-input').addEventListener('input', (e)=>{ lines[idx].qty = Number(e.target.value||0); lines[idx].amount = lines[idx].rate * lines[idx].qty; renderLines(); calcTotals(); });
      tr.querySelector('.minus-btn').addEventListener('click', ()=>{ lines.splice(idx,1); renderLines(); calcTotals(); });
      tr.querySelector('.plus-btn').addEventListener('click', ()=>{ lines.splice(idx+1,0,{productId:'',description:'',size:'',rate:0,qty:1,amount:0}); renderLines(); calcTotals(); });
      return tr;
    }

    function renderLines(){
      linesBody.innerHTML = '';
      if(lines.length===0) lines.push({productId:'',description:'',size:'',rate:0,qty:1,amount:0});
      lines.forEach((l,i)=> linesBody.appendChild(createLineRow(l,i)));
    }

   function calcTotals(){
  const sub = lines.reduce((s,l)=> s + (Number(l.amount)||0), 0);
  let discount = settings.splDiscountType==='percent' ? sub * (Number(settings.splDiscountValue||0)/100)
                                                     : Number(settings.splDiscountValue||0);
  const pf = Number(settings.pfCharges||0);
  const taxable = sub - discount + pf;
  const gst = taxable * (Number(settings.gstPercent||0)/100);
  const total = taxable + gst;

  // update editor summary
  subTotalEl.textContent = fmt(sub);
  document.getElementById('splDiscount').textContent = fmt(discount || 0);  // <-- added
  pfChargesEl.textContent = fmt(pf);
  gstAmountEl.textContent = fmt(gst);
  totalAmountEl.textContent = fmt(total);

  // update preview summary
  pSubTotal.textContent = fmt(sub);
  pDiscount.textContent = fmt(discount || 0);
  pPF.textContent = fmt(pf);
  pGST.textContent = fmt(gst);
  pTotal.textContent = fmt(total);
  pGSTPercent.textContent = settings.gstPercent;

  return { sub, discount, pf, gst, total };
}


    addLineBtn.addEventListener('click', ()=>{ lines.push({productId:'',description:'',size:'',rate:0,qty:1,amount:0}); renderLines(); calcTotals(); });

    openSettingsBtn.addEventListener('click', async ()=>{ await ensureSeed(); await loadSettings(); await renderUsersTable(); settingsModal.classList.remove('hidden'); setTimeout(()=>{ autoGrowTextarea(prodDescEl); if(prodDescEl) prodDescEl.style.minHeight = prodDescEl.style.minHeight || '56px'; }, 60); });
    closeSettingsBtn.addEventListener('click', ()=> settingsModal.classList.add('hidden'));

    // downscale images moderately
    function downscaleDataUrlIfNeeded(dataUrl, maxWidth=2000){
      return new Promise((resolve)=>{
        try{
          const img = new Image();
          img.onload = function(){
            if(img.width <= maxWidth){ resolve(dataUrl); return; }
            const scale = maxWidth / img.width;
            const canvas = document.createElement('canvas');
            canvas.width = Math.round(img.width * scale);
            canvas.height = Math.round(img.height * scale);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            const isPNG = dataUrl.indexOf('image/png') !== -1;
            const out = canvas.toDataURL(isPNG ? 'image/png' : 'image/jpeg', 0.95);
            resolve(out);
          };
          img.onerror = function(){ resolve(dataUrl); };
          img.src = dataUrl;
        }catch(e){ resolve(dataUrl); }
      });
    }

    // Save settings (persist showLogo & logoWidth and handle file upload)
    saveSettingsBtn.addEventListener('click', async ()=>{
      settings.splDiscountType = discountTypeEl.value;
      settings.splDiscountValue = Number(discountValueEl.value||0);
      settings.pfCharges = Number(pfValueEl.value||0);
      settings.gstPercent = Number(gstPercentEl.value||5);
      settings.logoUrl = logoUrlEl.value.trim();

// ✅ Prefer saved image if uploaded
if(settings.logoData){
  delete settings.logoUrl;
}
      settings.showLogo = !!showLogoEl.checked;
      settings.logoWidth = Number(logoWidthEl.value) || 120;

      settings.companyName = companyNameInput.value || settings.companyName;
      settings.companyReg = companyRegInput.value || settings.companyReg;
      settings.companyAddress = companyAddressInput.value || settings.companyAddress;
      settings.companyEmail = companyEmailInput.value || settings.companyEmail;
      settings.bankAcc = bankAccInput.value || settings.bankAcc;
      settings.bankIfsc = bankIfscInput.value || settings.bankIfsc;
      settings.bankName = bankNameInput.value || settings.bankName;
      settings.bankBranch = bankBranchInput.value || settings.bankBranch;

      // numbering: store into settings only (do NOT advance DB counter here)
      settings.invoicePrefix = (invoicePrefixEl && (invoicePrefixEl.value && String(invoicePrefixEl.value).trim())) || (`INV-${new Date().getFullYear()}-`);
      settings.invoiceSeq = (invoiceSeqEl && Number(invoiceSeqEl.value)) || settings.invoiceSeq || 1;

      // PDF/export
      settings.pdfQuality = Number(pdfQualityEl.value) || 0.8;
      settings.compressJpeg = !!compressJpegEl.checked;

      // High quality option
      settings.highQualityPdf = !!(hqCheckbox && hqCheckbox.checked);

      // Persist global settings (we intentionally do NOT write 'invoice_seq' DB counter here)
      await db.settings.put({ key:'global', value: settings });

      // handle uploaded file
      if(logoFileEl.files && logoFileEl.files[0]){
        const f = logoFileEl.files[0];
        const reader = new FileReader();
        reader.onload = async function(e){
          let base64 = e.target.result;
          base64 = await downscaleDataUrlIfNeeded(base64, 2400);
          settings.logoData = base64;
          await db.settings.put({key:'global', value:settings});
          await loadSettings();
          settingsModal.classList.add('hidden');
          // autosave
          await tryAutoSaveToHandle();
        };
        reader.readAsDataURL(f);
      } else {
        settings.logoData = settings.logoData || null; // leave as-is if previously stored
        await db.settings.put({key:'global', value:settings});
        await loadSettings();
        settingsModal.classList.add('hidden');
        // autosave
        await tryAutoSaveToHandle();
      }
    });

    // Apply invoice number to editor (without incrementing DB sequence)
    if(applyInvoiceNumberBtn){
      applyInvoiceNumberBtn.addEventListener('click', async () => {
        const prefix = (invoicePrefixEl && (invoicePrefixEl.value || '')).toString() || (`INV-${new Date().getFullYear()}-`);
        const seq = (invoiceSeqEl && Number(invoiceSeqEl.value)) ? Number(invoiceSeqEl.value) : (settings.invoiceSeq || 1);
        const applied = formatInvoice(prefix, seq);
        invoiceNoEl.value = applied;
        // update settings object and persist global so it's remembered
        settings.invoicePrefix = prefix;
        settings.invoiceSeq = seq;
        await db.settings.put({ key:'global', value: settings });
        alert('Invoice number set: ' + applied + '\nSequence will advance after PDF export.');
      });
    }

    // toggle high quality via button (mirrors checkbox and persists)
    if(toggleHighQualityBtn){
      toggleHighQualityBtn.addEventListener('click', async ()=>{
        settings.highQualityPdf = !settings.highQualityPdf;
        if(hqCheckbox) hqCheckbox.checked = settings.highQualityPdf;
        updateHighQualityUi();
        await db.settings.put({ key:'global', value: settings });
        await tryAutoSaveToHandle();
      });
    }

    // helper to sync HQ UI
    function updateHighQualityUi(){
      const enabled = !!(settings.highQualityPdf);
      if(toggleHighQualityBtn) toggleHighQualityBtn.textContent = enabled ? 'Disable High Quality' : 'Enable High Quality';
      if(hqIndicatorPreview) {
        if(enabled) hqIndicatorPreview.classList.remove('hidden'); else hqIndicatorPreview.classList.add('hidden');
      }
    }

    // --- Save / update auth credentials: add to users store (multi-user) ---
    if(saveAuthBtn){
      saveAuthBtn.addEventListener('click', async () => {
        const u = (authUsernameEl && (authUsernameEl.value||'').trim()) || '';
        const p = authPasswordEl ? authPasswordEl.value || '' : '';
        if(!u) return alert('Enter username');
        const editId = saveAuthBtn.dataset.edit;
        try{
          // ensure users store exists
          if(!db.users){
            // if users not available, fall back to legacy behavior (store in settings.auth)
            if(!p) return alert('Enter password');
            const hashed = await sha256hex(p);
            await db.settings.put({ key:'auth', value: { username: u, passwordHash: hashed } });
            alert('Saved legacy auth (no users store available).');
            await tryAutoSaveToHandle();
            return;
          }

          if(editId){
            // update existing user
            await updateUser(Number(editId), u, p || undefined);
            delete saveAuthBtn.dataset.edit;
            saveAuthBtn.textContent = 'Add User';
            alert('User updated.');
          } else {
            // adding new user requires password
            if(!p) return alert('Enter password for new user');
            await addUser(u, p);
            alert('User added.');
          }
          authUsernameEl.value = ''; authPasswordEl.value = '';
          await tryAutoSaveToHandle();
        }catch(err){
          alert('Could not add/update user: ' + (err.message || err));
        }
      });
    }

    if(resetAuthBtn){
      resetAuthBtn.addEventListener('click', async () => {
        if(!confirm('Reset credentials to default admin / admin123? This will remove other users in the users table.')) return;
        try{
          if(db.users){
            await db.users.clear();
            const hashed = await sha256hex('admin123');
            await db.users.add({ username:'admin', passwordHash: hashed, createdAt: new Date().toISOString() });
          }
          // also update legacy settings.auth for compatibility
          await db.settings.put({ key:'auth', value: { username:'admin', password:'admin123' } });
          if(authUsernameEl) authUsernameEl.value = 'admin';
          if(authPasswordEl) authPasswordEl.value = 'admin123';
          await renderUsersTable();
          alert('Credentials reset to admin / admin123');
          await tryAutoSaveToHandle();
        }catch(e){
          console.error('reset users failed', e);
          alert('Reset failed: ' + (e.message || e));
        }
      });
    }

    // Save invoice offline (generate invoice number)
    saveBtn.addEventListener('click', async ()=>{
      const invoiceNumberToSave = await generateInvoiceNumber();
      const t = calcTotals();
      const invoice = { invoiceNumber: invoiceNumberToSave, issueDate: issueDateEl.value, customer: customerEl.value, userName: userNameEl.value, lines: JSON.parse(JSON.stringify(lines)), ...t, createdAt: new Date().toISOString() };
      await db.invoices.add(invoice);
      invoiceNoEl.value = await peekNextInvoiceNumber();
      alert('Invoice saved offline as ' + invoiceNumberToSave);
      // autosave to file handle if open
      await tryAutoSaveToHandle();
    });

    // Preview populate (applies logo visibility & width)
    previewBtn.addEventListener('click', ()=>{
      printInvoiceNo.textContent = invoiceNoEl.value;
      printDate.textContent = issueDateEl.value || new Date().toISOString().slice(0,10);
      // preserve multiline customer details in preview
      printBillTo.textContent = (customerEl.value || '');
      printUserName.textContent = userNameEl.value || '';

      // pick the best logo data
      if(settings.logoData) printLogo.src = settings.logoData;
      else if(settings.logoUrl) printLogo.src = settings.logoUrl;
      else printLogo.src = '';

      applyLogoVisibility();

      printBankAcc.textContent = settings.bankAcc || '';
      printBankIfsc.textContent = settings.bankIfsc || '';
      printCompanyName.textContent = settings.companyName;
      printCompanyReg.textContent = settings.companyReg;
      printCompanyAddr.textContent = settings.companyAddress;
      printCompanyEmail.textContent = settings.companyEmail;

      // lines
      printLinesBody.innerHTML = '';
      lines.forEach((l,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td style="white-space:pre-line">${escapeHtml(l.description||'')}</td><td>${escapeHtml(l.size||'')}</td><td style='text-align:right'>${fmt(l.rate)}</td><td style='text-align:right'>${l.qty}</td><td style='text-align:right'>${fmt(l.amount)}</td>`;
        printLinesBody.appendChild(tr);
      });

      const mode = document.querySelector('input[name="previewMode"]:checked')?.value || 'desktop';
      if(mode==='mobile'){ previewWrapper.classList.remove('preview-mode-desktop'); previewWrapper.classList.add('preview-mode-mobile'); }
      else { previewWrapper.classList.remove('preview-mode-mobile'); previewWrapper.classList.add('preview-mode-desktop'); }

      // show indicator if high quality enabled
      if(settings.highQualityPdf) hqIndicatorPreview.classList.remove('hidden'); else hqIndicatorPreview.classList.add('hidden');

      previewModal.classList.remove('hidden');
    });

    document.querySelectorAll('input[name="previewMode"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const mode = document.querySelector('input[name="previewMode"]:checked')?.value || 'desktop';
        if(mode==='mobile'){ previewWrapper.classList.remove('preview-mode-desktop'); previewWrapper.classList.add('preview-mode-mobile'); }
        else { previewWrapper.classList.remove('preview-mode-mobile'); previewWrapper.classList.add('preview-mode-desktop'); }
      });
    });

    closePreviewBtn.addEventListener('click', ()=> previewModal.classList.add('hidden'));

    // utilities for PDF slicing
    function sliceCanvasToPages(originalCanvas, pageHeightPx){
      const slices = [];
      const fullH = originalCanvas.height;
      let y = 0;
      while(y < fullH){
        const sliceH = Math.min(pageHeightPx, fullH - y);
        const tmp = document.createElement('canvas');
        tmp.width = originalCanvas.width;
        tmp.height = sliceH;
        const ctx = tmp.getContext('2d');
        ctx.drawImage(originalCanvas, 0, y, originalCanvas.width, sliceH, 0, 0, originalCanvas.width, sliceH);
        slices.push(tmp);
        y += sliceH;
      }
      return slices;
    }

    // Export to PDF (previewArea contains logo at top so export will include it)
    exportPdfBtn.addEventListener('click', async () => {
  try {
    const { jsPDF } = window.jspdf;
    // Read settings (use the saved settings.highQualityPdf flag)
    const highQuality = !!(settings.highQualityPdf);
    const quality = (typeof settings.pdfQuality !== 'undefined') ? Number(settings.pdfQuality) : (Number(pdfQualityEl.value) || 0.8);
    // If highQuality set then force PNG and high scale; otherwise allow JPEG and chosen quality
    const useJpeg = !highQuality && ((typeof settings.compressJpeg !== 'undefined') ? !!settings.compressJpeg : !!compressJpegEl.checked);
    const mode = document.querySelector('input[name="previewMode"]:checked')?.value || 'desktop';
    const el = document.getElementById('previewArea');

    // Ensure logo visibility is applied before capture
    applyLogoVisibility();

    // choose canvas scale: higher when highQuality true
    const dpr = Math.min(3, window.devicePixelRatio || 1);
    const baseScale = Math.max(1.5, dpr * 1.5);
    const canvasScale = highQuality ? Math.max(2.5, dpr * 2.8) : baseScale;

    // html2canvas capture
    const canvas = await html2canvas(el, { scale: canvasScale, useCORS: true, allowTaint: false, logging: false, scrollY: -window.scrollY });

    const pdf = new jsPDF('p', 'mm', 'a4');
    const A4_WIDTH_MM = 210;
    const A4_HEIGHT_MM = 297;
    const margin = 10;
    const mobileVisualWidthMm = 90;
    let usableWidthMm = A4_WIDTH_MM - margin * 2;
    if (mode === 'mobile') {
      usableWidthMm = Math.min(mobileVisualWidthMm, A4_WIDTH_MM - margin * 2);
    }
    const pxPerMm = canvas.width / usableWidthMm;
    const pageHeightPx = Math.floor((A4_HEIGHT_MM - margin * 2) * pxPerMm);
    const slices = sliceCanvasToPages(canvas, pageHeightPx);

    for (let i = 0; i < slices.length; i++) {
      const c = slices[i];
      // choose mime and addImage format based on highQuality flag
      const mime = highQuality ? 'image/png' : (useJpeg ? 'image/jpeg' : 'image/png');
      const imgType = highQuality ? 'PNG' : (useJpeg ? 'JPEG' : 'PNG');
      const dataUrl = c.toDataURL(mime, useJpeg ? quality : undefined);
      const imgWidthPx = c.width;
      const imgHeightPx = c.height;
      const imgWidthMm = usableWidthMm;
      const imgHeightMm = (imgHeightPx / pxPerMm);
      const x = (A4_WIDTH_MM - imgWidthMm) / 2;
      const y = margin;
      if (i > 0) pdf.addPage();
      // 'FAST' is fine; with PNG highQuality, jsPDF will embed PNG (larger)
      pdf.addImage(dataUrl, imgType, x, y, imgWidthMm, imgHeightMm, undefined, 'FAST');
    }

    const filename = (invoiceNoEl.value || 'invoice') + (mode === 'mobile' ? '_mobile' : '') + (highQuality ? '_HQ' : '') + '.pdf';
    pdf.save(filename);

    // Update invoice sequence if invoiceNoEl had valid sequence
    const currentInv = (invoiceNoEl.value || '').trim();
    if (currentInv) {
      const prefix = (settings.invoicePrefix || '').toString();
      let seqNum = null;
      if (prefix) {
        try {
          const escPrefix = prefix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(escPrefix + '(\\d+)$');
          const m = currentInv.match(re);
          if (m && m[1]) seqNum = Number(m[1]);
        } catch (e) { }
      }
      if (seqNum === null) {
        const m2 = currentInv.match(/(\d+)$/);
        if (m2 && m2[1]) seqNum = Number(m2[1]);
      }
      if (seqNum !== null && !isNaN(seqNum)) {
        // increment the DB counter (sequence advances only after successful export)
        await db.settings.put({ key: 'invoice_seq', value: seqNum + 1 });
        // keep our settings object in sync and persist it
        settings.invoiceSeq = seqNum + 1;
        if (typeof invoiceSeqEl !== 'undefined' && invoiceSeqEl) invoiceSeqEl.value = seqNum + 1;
        // persist global settings so the prefix & seq are consistent on reload
        await db.settings.put({ key: 'global', value: settings });
        invoiceNoEl.value = await peekNextInvoiceNumber();
      }
    }

    alert('PDF exported (' + (mode === 'mobile' ? 'mobile-fit' : 'desktop') + (highQuality ? ', HIGH QUALITY' : '') + ' mode).');
  } catch (err) {
    console.error('Export PDF failed', err);
    alert('Export failed: ' + (err.message || err));
  }
});

    // Export / Import Data
    exportDataBtn.addEventListener('click', async ()=>{
      try{
        const [productsArr, settingsArr, invoicesArr, customersArr, usersArr] = await Promise.all([
          db.products.toArray().catch(()=>[]),
          db.settings.toArray().catch(()=>[]),
          db.invoices.toArray().catch(()=>[]),
          (db.customers ? db.customers.toArray().catch(()=>[]) : Promise.resolve([])),
          (db.users ? db.users.toArray().catch(()=>[]) : Promise.resolve([]))
        ]);
        const seq = (await db.settings.get('invoice_seq')) || { key:'invoice_seq', value:0 };
        const payload = { products: productsArr, settings: settingsArr, invoices: invoicesArr, customers: customersArr, users: usersArr, counters: { invoice_seq: seq.value || 0 }, exportedAt: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `invoicedata_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        alert('Exported data to JSON');
      } catch(err){ console.error(err); alert('Export failed: '+ (err.message || err)); }
    });

    // Wire FS API open/save buttons
    const openDbFileBtn = document.getElementById('openDbFileBtn');
    const saveDbFileBtn = document.getElementById('saveDbFileBtn');
    openDbFileBtn.addEventListener('click', pickDatabaseFile);
    saveDbFileBtn.addEventListener('click', writeToDatabaseFile);

    importDataBtn.addEventListener('click', ()=> importFileInput.click());
    importFileInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return; const text = await f.text();
      try{
        const data = JSON.parse(text);
        await importDataFromObject(data);
        alert('Import complete');
        // if the imported file looks like a DB snapshot, optionally set persistedFileHandle to null (we only set via Open)
      } catch(err){ console.error(err); alert('Import failed: ' + err.message); }
      importFileInput.value = '';
    });

    async function importDataFromObject(data){
      if(!data) throw new Error('No data');
      if(Array.isArray(data.products)){
        for(const p of data.products){ if(!p.id) p.id = cryptoRandomId(); await db.products.put(p).catch(()=>{}); }
      }
      if(Array.isArray(data.settings)){
        for(const s of data.settings){ if(s && s.key) await db.settings.put({ key: s.key, value: s.value }).catch(()=>{}); }
      } else if(data.settings && typeof data.settings === 'object'){
        // support map-style settings import
        for(const k of Object.keys(data.settings)){ await db.settings.put({ key:k, value: data.settings[k] }).catch(()=>{}); }
      }
      if(Array.isArray(data.invoices)){
        for(const inv of data.invoices){ const copy = Object.assign({}, inv); delete copy.id; await db.invoices.add(copy).catch(()=>{}); }
      }
      if(Array.isArray(data.customers)){
        for(const c of data.customers){ if(!c.id) c.id = cryptoRandomId(); await db.customers.put(c).catch(()=>{}); }
      }
      if(Array.isArray(data.users) && db.users){
        for(const u of data.users){
          // normalise older user shapes
          const rec = { username: u.username || u.name || u.user || '', passwordHash: u.passwordHash || u.hash || null, createdAt: u.createdAt || new Date().toISOString() };
          if(!rec.username) continue;
          // avoid duplicates by username
          const existing = await db.users.where('username').equals(rec.username).first();
          if(existing) {
            // update if incoming has passwordHash
            if(rec.passwordHash) await db.users.update(existing.id, { passwordHash: rec.passwordHash }).catch(()=>{});
          } else {
            await db.users.add(rec).catch(()=>{});
          }
        }
      }
      if(data.counters && typeof data.counters.invoice_seq !== 'undefined'){
        await db.settings.put({ key:'invoice_seq', value: Number(data.counters.invoice_seq) });
      }
      products = await db.products.toArray().catch(()=>[]);
      customers = await db.customers.toArray().catch(()=>[]);
      renderProductsTable(); renderLines(); calcTotals(); await loadSettings(); renderCustomersTable(); populateCustomerSelect();
      // render users table if present
      try{ await renderUsersTable(); }catch(e){}
      // autosave to file handle (if any)
      await tryAutoSaveToHandle();
    }

    // initialization
    (async function init(){
      await ensureSeed();
      await loadSettings();
      // ensure users table seeded and UI ready
      try{ await renderUsersTable(); }catch(e){}
      issueDateEl.value = new Date().toISOString().slice(0,10);
      invoiceNoEl.value = await peekNextInvoiceNumber();
      lines = [{productId:'',description:'',size:'',rate:0,qty:1,amount:0}];
      products = await db.products.toArray().catch(()=>[]);
      renderProductsTable();
      renderLines(); calcTotals();
      setTimeout(()=> { autoGrowTextarea(prodDescEl); autoGrowTextarea(customerEl); }, 60);
    })();

    function formatInvoice(prefix, seq){
      const padded = String(seq).padStart(5,'0');
      return `${prefix}${padded}`;
    }

    async function peekNextInvoiceNumber(){
      settings.invoicePrefix = settings.invoicePrefix || (`INV-${new Date().getFullYear()}-`);
      const seqRec = await db.settings.get('invoice_seq');
      const seqFromDB = (seqRec && typeof seqRec.value !== 'undefined') ? Number(seqRec.value) : (settings.invoiceSeq || 1);
      const allInv = await db.invoices.toArray().catch(()=>[]);
      let maxSeq = 0;
      const prefix = settings.invoicePrefix;
      for(const inv of allInv){
        if(!inv || !inv.invoiceNumber) continue;
        if(typeof inv.invoiceNumber !== 'string') continue;
        if(inv.invoiceNumber.startsWith(prefix)){
          const tail = inv.invoiceNumber.slice(prefix.length).replace(/^0+/, '') || '0';
          const n = Number(tail);
          if(!isNaN(n) && n > maxSeq) maxSeq = n;
        } else {
          const m = inv.invoiceNumber.match(/(\d+)$/);
          if(m){
            const n = Number(m[1]);
            if(!isNaN(n) && n > maxSeq) maxSeq = n;
          }
        }
      }
      const candidate = Math.max(maxSeq + 1, seqFromDB);
      return formatInvoice(prefix, candidate);
    }

    async function generateInvoiceNumber(){
      settings.invoicePrefix = settings.invoicePrefix || (`INV-${new Date().getFullYear()}-`);
      const allInv = await db.invoices.toArray().catch(()=>[]);
      let maxSeq = 0;
      const prefix = settings.invoicePrefix;
      for(const inv of allInv){
        if(!inv || !inv.invoiceNumber) continue;
        if(typeof inv.invoiceNumber !== 'string') continue;
        if(inv.invoiceNumber.startsWith(prefix)){
          const tail = inv.invoiceNumber.slice(prefix.length).replace(/^0+/, '') || '0';
          const n = Number(tail);
          if(!isNaN(n) && n > maxSeq) maxSeq = n;
        } else {
          const m = inv.invoiceNumber.match(/(\d+)$/);
          if(m){
            const n = Number(m[1]);
            if(!isNaN(n) && n > maxSeq) maxSeq = n;
          }
        }
      }
      const seqRec = await db.settings.get('invoice_seq');
      const seqFromDB = (seqRec && typeof seqRec.value !== 'undefined') ? Number(seqRec.value) : (settings.invoiceSeq || 1);
      const next = Math.max(maxSeq + 1, seqFromDB);
      await db.settings.put({ key:'invoice_seq', value: next + 1 });
      await db.settings.put({ key:'global', value:settings });
      return formatInvoice(settings.invoicePrefix, next);
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]; }); }

    (function(){
      // if the global user was set by auth-check script, use it
      const logged = window.__LOGGED_IN_USER || localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
      try {
        // populate the User Name input if empty
        const userInput = document.getElementById('userName');
        if(userInput && (!userInput.value || userInput.value.trim()==='')){
          if(logged) userInput.value = logged;
        }
      } catch(e){}

      // Logout handler
      const logoutBtn = document.getElementById('logoutBtn');
      if(logoutBtn){
        logoutBtn.addEventListener('click', async function(){
          // clear both storage places
          try { localStorage.removeItem('loggedInUser'); sessionStorage.removeItem('loggedInUser'); } catch(e){}
          // clear session marker in DB if you use it
          try {
            if(window.Dexie){
              const db = new Dexie('InvoiceDB');
              await db.open().catch(()=>null);
              if(db && db.settings) await db.settings.delete('session').catch(()=>null);
            }
          } catch(e){}
          // redirect to login
          window.location.href = 'login.html';
        });
      }
    })();
  </script>
</body>
</html>
