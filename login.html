<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — Invoice App</title>
  <style>
    :root{--bg:#f3f4f6;--accent:#0b5ed7;--muted:#6b7280}
    body{
      margin:0;
      background:var(--bg);
      font-family:Arial,Helvetica,sans-serif;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      padding:16px
    }
    .card{
      width:100%;
      max-width:420px;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08)
    }
    h2{margin:0 0 12px;font-size:20px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input,select{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:8px;
      margin-top:6px;
      font-size:14px;
      box-sizing:border-box
    }
    .actions{display:flex;gap:8px;margin-top:16px}
    button{
      background:var(--accent);
      color:#fff;
      border:0;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px
    }
    .secondary{
      background:#fff;
      color:var(--accent);
      border:1px solid #dde6f8
    }
    .small{font-size:13px;padding:8px 10px}
    .note{font-size:12px;color:#666;margin-top:12px}
    .error{color:#b00020;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="loginTitle">
    <h2 id="loginTitle">Sign in to Invoice App</h2>

    <label for="username">Username</label>
    <input id="username" autocomplete="username" placeholder="username" autofocus />

    <label for="password">Password</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="password" />

    <label for="role">Login As</label>
    <select id="role">
      <option value="retailer">Retailer</option>
      <option value="distributor">Distributor</option>
    </select>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
      <label style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px">
        <input id="remember" type="checkbox" /> Remember
      </label>
      <div>
        <!-- Kept both buttons (UI 100% same), but both now work with Firebase only -->
        <button id="openDbBtn" class="secondary small">Open DB File</button>
        <button id="forgot" class="secondary small">Reset to default</button>
      </div>
    </div>

    <div class="actions">
      <button id="loginBtn">Sign In</button>
      <button id="guestBtn" class="secondary">Continue as Guest</button>
    </div>

    <div class="note">
      Default (first-time) credentials: <strong>admin / admin123</strong>. You can change these later in Settings.
    </div>

    <!-- Firebase status box (unchanged UI) -->
    <div id="firebaseStatusBox" 
         style="margin-top:12px;padding:8px 10px;border-radius:8px;
                background:#f1f5ff;border:1px solid #d4e3ff;
                display:flex;align-items:center;gap:8px;font-size:13px;
                transition:all .3s ease;">
      <div id="fbDot" style="
          width:10px;height:10px;border-radius:50%;
          background:#ccc;animation:blink 1.2s infinite;">
      </div>
      <div id="firebaseStatusText">Checking Firebase connection…</div>
    </div>

    <style>
      @keyframes blink {
        0%{ opacity:1 }
        50%{ opacity:0.3 }
        100%{ opacity:1 }
      }
    </style>

    <div id="error" class="error" aria-live="polite" hidden></div>
  </div>

  <!-- Hidden file input kept ONLY for UI compatibility (no offline import now) -->
  <input id="loginFileInput" type="file" accept="application/json" style="display:none" />

  <!-- Firebase (Compat mode so old syntax works) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Your Firebase config (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyDCl3vm-k-BKIVTranYhizXHD-oZei2tFo",
      authDomain: "invoiceapp-3e7f2.firebaseapp.com",
      databaseURL: "https://invoiceapp-3e7f2-default-rtdb.firebaseio.com",
      projectId: "invoiceapp-3e7f2",
      storageBucket: "invoiceapp-3e7f2.firebasestorage.app",
      messagingSenderId: "616961205905",
      appId: "1:616961205905:web:9f4cc9a354ced797004130",
      measurementId: "G-CZF92EFR0E"
    };

    // Initialize Firebase
    const appFirebase = firebase.initializeApp(firebaseConfig);
    const firebaseDB = firebase.database();

    // ---------------------------------------------------------------------
    // ENHANCED FIREBASE CONNECTION STATUS UI (same as before)
    // ---------------------------------------------------------------------
    let lastCloudSuccess = null;
    const statusBox = document.getElementById("firebaseStatusBox");
    const fbDot = document.getElementById("fbDot");
    const fbText = document.getElementById("firebaseStatusText");

    function updateUI(connected){
      if(connected){
        statusBox.style.background = "#e8ffed";
        statusBox.style.border = "1px solid #b3f3c0";
        fbDot.style.background = "#14b814";
        fbText.innerHTML = "Connected to Firebase";

        lastCloudSuccess = new Date().toLocaleTimeString();
        statusBox.title = "Last connected: " + lastCloudSuccess;
      } else {
        statusBox.style.background = "#ffecec";
        statusBox.style.border = "1px solid #f3b3b3";
        fbDot.style.background = "#d62828";
        fbText.innerHTML = "Not Connected to Firebase";
        statusBox.title = "Trying to reconnect…";
      }
    }

    // Firebase real-time connection detection
    firebaseDB.ref(".info/connected").on("value", snap => {
      const ok = snap.val() === true;
      updateUI(ok);
    });

    // Auto retry (every 4 seconds)
    setInterval(async () => {
      try {
        await firebaseDB.ref(".info/connected").once("value");
      } catch {
        updateUI(false);
      }
    }, 4000);
  </script>

  <script>
    (function(){
      // ---------------- DOM ELEMENTS ----------------
      const usernameEl    = document.getElementById('username');
      const passwordEl    = document.getElementById('password');
      const rememberEl    = document.getElementById('remember');
      const errorEl       = document.getElementById('error');
      const loginBtn      = document.getElementById('loginBtn');
      const guestBtn      = document.getElementById('guestBtn');
      const forgotBtn     = document.getElementById('forgot');
      const openDbBtn     = document.getElementById('openDbBtn');
      const loginFileInput= document.getElementById('loginFileInput');

      // ---------------- SESSION CHECK (same behavior) ----------------
      try {
        const sessUser = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
        if (sessUser) {
          // Already logged in – go directly to invoice page
          window.location.href = 'invoice.html';
          return;
        }
      } catch(e) {
        console.warn('Session storage error', e);
      }

      // ---------------- CLOUD STATE (Firebase-only) ----------------
      let cloudUsers    = [];
      let cloudSettings = {};
      let cloudPromise  = null;

      // SHA-256 helper
      async function sha256hex(text){
        const enc  = new TextEncoder();
        const data = enc.encode(text);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
      }

      // Fetch everything needed for login from Firebase only
      async function fetchCloudData(){
        try {
          const snap = await firebaseDB.ref("invoice_app_data").once("value");
          if (!snap.exists()) {
            console.warn("⚠ No cloud data found at invoice_app_data");
            cloudUsers = [];
            cloudSettings = {};
            return;
          }

          const data = snap.val() || {};

          // Users
          if (data.users) {
            if (Array.isArray(data.users)) {
              cloudUsers = data.users;
            } else {
              cloudUsers = Object.values(data.users);
            }
          } else {
            cloudUsers = [];
          }

          // Settings (including auth)
          if (data.settings && typeof data.settings === "object") {
            cloudSettings = data.settings;
          } else {
            cloudSettings = {};
          }

          console.log("✅ Cloud data loaded for login (Firebase only)");
        } catch(err) {
          console.error("Cloud load error:", err);
          cloudUsers    = [];
          cloudSettings = {};
        }
      }

      function ensureCloudLoaded(){
        if (!cloudPromise) {
          cloudPromise = fetchCloudData();
        }
        return cloudPromise;
      }

      // ---------------- VERIFY FUNCTIONS ----------------
      async function verifyAgainstUsers(username, passwordPlain){
        await ensureCloudLoaded();

        if (!cloudUsers || cloudUsers.length === 0) {
          return { ok:false };
        }

        // Find user in cloud users
        const rec = cloudUsers.find(u => u && u.username === username);
        if (!rec) return { ok:false };

        const providedHash = await sha256hex(passwordPlain);
        let storedHash = rec.passwordHash || null;

        // Legacy: if password stored in plain text in Firebase
        if (!storedHash && rec.password) {
          storedHash = await sha256hex(String(rec.password));
        }

        if (!storedHash) return { ok:false };

        return { ok: providedHash === storedHash, user: rec.username };
      }

      async function verifyAgainstLegacy(username, passwordPlain){
        await ensureCloudLoaded();

        const auth = (cloudSettings && cloudSettings.auth)
          ? cloudSettings.auth
          : { username: 'admin', password: 'admin123' };

        const providedHash = await sha256hex(passwordPlain);
        let storedHash = auth.passwordHash || null;

        if (!storedHash && auth.password) {
          storedHash = await sha256hex(String(auth.password));
        }

        if (username === auth.username && storedHash && providedHash === storedHash) {
          return { ok:true };
        }
        return { ok:false };
      }

      // ---------------- SESSION HELPER (uses remember checkbox) ----------------
      function setSession(user, role, remember){
        try {
          // Session always stored in sessionStorage
          sessionStorage.setItem('loggedInUser', user);
          sessionStorage.setItem('loggedInRole', role);

          // If "Remember" checked, also store in localStorage
          if (remember) {
            localStorage.setItem('loggedInUser', user);
            localStorage.setItem('loggedInRole', role);
          } else {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('loggedInRole');
          }
        } catch(e){
          console.warn('setSession storage error', e);
        }

        console.log("Session Saved:", {
          user,
          role,
          remember,
          localRole: localStorage.getItem('loggedInRole'),
          sessionRole: sessionStorage.getItem('loggedInRole')
        });
      }

      // ---------------- LOGIN BUTTON ----------------
      loginBtn.addEventListener('click', async function(e){
        e.preventDefault();

        errorEl.hidden = true;
        errorEl.textContent = '';

        const username    = usernameEl.value.trim();
        const password    = passwordEl.value;
        const selectedRole= document.getElementById('role').value;
        const remember    = !!rememberEl.checked;

        if (!username || !password) {
          alert("Enter username and password");
          return;
        }

        try {
          const verified = await verifyAgainstUsers(username, password);
          const legacy   = await verifyAgainstLegacy(username, password);

          if (verified.ok || legacy.ok) {
            setSession(username, selectedRole, remember);

            if (selectedRole === 'distributor') {
              window.location.href = 'distributor.html';
            } else {
              window.location.href = 'invoice.html';
            }
          } else {
            alert("Invalid username or password");
          }
        } catch(err) {
          console.error("Login error:", err);
          errorEl.hidden = false;
          errorEl.textContent = "Login failed. Please try again.";
        }
      });

      // ENTER to login
      [usernameEl, passwordEl].forEach(el =>
        el.addEventListener('keydown', function(e){
          if(e.key === "Enter") {
            loginBtn.click();
          }
        })
      );

      // ---------------- GUEST MODE (Firebase-only app, but guest is local session) ----------------
      guestBtn.addEventListener('click', function(){
        const guest  = 'guest';
        const role   = 'all-access';
        const remember = !!rememberEl.checked;

        setSession(guest, role, remember);
        window.location.href = 'invoice.html';
      });

      // ---------------- RESET TO DEFAULT (writes to Firebase, no Dexie) ----------------
      forgotBtn.addEventListener('click', async function(){
        if (!confirm("Reset credentials to admin/admin123?")) return;

        const authNode = { username:'admin', password:'admin123' };

        try {
          await firebaseDB.ref("invoice_app_data/settings/auth").set(authNode);
          cloudSettings.auth = authNode;
          alert("Credentials reset");
        } catch(err) {
          console.error("Reset error:", err);
          alert("Reset failed. Please check Firebase connection.");
        }
      });

      // ---------------- OPEN DB BUTTON (now: REFRESH FROM CLOUD) ----------------
      openDbBtn.addEventListener('click', async function(){
        // No more file import / offline DB.
        // This button now simply forces reloading login data from Firebase.
        try {
          document.body.style.cursor = "wait";
          cloudPromise = null;        // clear old promise
          await ensureCloudLoaded();  // reload data
          alert("Cloud data reloaded for login.");
        } catch(err) {
          console.error("Cloud reload error:", err);
          alert("Unable to reload cloud data.");
        } finally {
          document.body.style.cursor = "default";
        }
      });

      // (Hidden file input is not used anymore – kept only for 100% UI compatibility)
      loginFileInput.addEventListener('change', function(){
        // Do nothing: offline DB import removed.
        this.value = "";
      });

      // Kick off initial cloud load in background
      ensureCloudLoaded();
    })();
  </script>
</body>
</html>
