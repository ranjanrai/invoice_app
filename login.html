<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — Invoice App</title>
  <style>
    :root{--bg:#f3f4f6;--accent:#0b5ed7;--muted:#6b7280}
    body{margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111;display:flex;align-items:center;justify-content:center;height:100vh;padding:16px}
    .card{width:100%;max-width:420px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    h2{margin:0 0 12px;font-size:20px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:6px;font-size:14px;box-sizing:border-box}
    .actions{display:flex;gap:8px;margin-top:16px}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px}
    .secondary{background:#fff;color:var(--accent);border:1px solid #dde6f8}
    .small{font-size:13px;padding:8px 10px}
    .note{font-size:12px;color:#666;margin-top:12px}
    .error{color:#b00020;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="loginTitle">
    <h2 id="loginTitle">Sign in to Invoice App</h2>

    <label for="username">Username</label>
    <input id="username" autocomplete="username" placeholder="username" autofocus />

    <label for="password">Password</label>
    <input id="password" type="password" autocomplete="current-password" placeholder="password" />

    <label for="role">Login As</label>
    <select id="role" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:6px;font-size:14px;">
      <option value="retailer">Retailer</option>
      <option value="distributor">Distributor</option>
    </select>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
      <label style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:8px">
        <input id="remember" type="checkbox" /> Remember
      </label>
      <div>
        <button id="openDbBtn" class="secondary small">Open DB File</button>
        <button id="forgot" class="secondary small">Reset to default</button>
      </div>
    </div>

    <div class="actions">
      <button id="loginBtn">Sign In</button>
      <button id="guestBtn" class="secondary">Continue as Guest</button>
    </div>

    <div class="note">
      Default (first-time) credentials: <strong>admin / admin123</strong>. You can change these later in Settings.
    </div>

    <div id="error" class="error" aria-live="polite" hidden></div>
  </div>

  <input id="loginFileInput" type="file" accept="application/json" style="display:none" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>

  <script>
    (async function(){

      const db = new Dexie('InvoiceDB');
      db.version(1).stores({
        products: 'id,name,size,rate,description',
        settings: 'key',
        invoices: '++id,invoiceNumber,createdAt'
      });
      db.version(2).stores({
        products: 'id,name,size,rate,description',
        settings: 'key',
        invoices: '++id,invoiceNumber,createdAt',
        customers: 'id,name'
      });
      db.version(3).stores({
        products: 'id,name,size,rate,description',
        settings: 'key',
        invoices: '++id,invoiceNumber,createdAt',
        customers: 'id,name',
        users: '++id,username'
      }).upgrade(async tx => {
        const settingsTable = tx.table('settings');
        const usersTable = tx.table('users');
        const authRec = await settingsTable.get('auth').catch(()=>null);
        const count = await usersTable.count().catch(()=>0);

        if(authRec && authRec.value && !count){
          const v = authRec.value;
          const username = v.username || 'admin';
          let passwordHash = v.passwordHash;

          if(!passwordHash && v.password){
            const enc = new TextEncoder();
            const hashBuffer = await crypto.subtle.digest('SHA-256', enc.encode(String(v.password)));
            passwordHash = Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
          }

          if(passwordHash){
            await usersTable.add({ username, passwordHash, createdAt: new Date().toISOString() }).catch(()=>{});
          }
        }
      });

      await db.open();

      async function sha256hex(text){
        const enc = new TextEncoder();
        const data = enc.encode(text);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
      }

      const usernameEl = document.getElementById('username');
      const passwordEl = document.getElementById('password');
      const rememberEl = document.getElementById('remember');
      const errorEl = document.getElementById('error');
      const loginBtn = document.getElementById('loginBtn');
      const guestBtn = document.getElementById('guestBtn');
      const forgotBtn = document.getElementById('forgot');
      const openDbBtn = document.getElementById('openDbBtn');
      const loginFileInput = document.getElementById('loginFileInput');

      // Existing session?
      try {
        const sess = localStorage.getItem('loggedInUser') || sessionStorage.getItem('loggedInUser');
        if(sess){
          window.location.href = 'invoice.html';
          return;
        }
      }catch{}

      async function verifyAgainstUsers(username, passwordPlain){
        if(!db.users) return { ok:false };
        const rec = await db.users.where('username').equals(username).first();
        if(!rec) return { ok:false };

        if(rec.passwordHash){
          const providedHash = await sha256hex(passwordPlain);
          return { ok: providedHash === rec.passwordHash, user: rec.username };
        }

        return { ok:false };
      }

      async function verifyAgainstLegacy(username, passwordPlain){
        const authRec = await db.settings.get('auth').catch(()=>null);
        const stored = (authRec && authRec.value) ? authRec.value : { username:'admin', password:'admin123' };
        const providedHash = await sha256hex(passwordPlain);
        const storedHash = stored.passwordHash || (stored.password ? await sha256hex(stored.password) : null);

        if(username === stored.username && storedHash && providedHash === storedHash){
          return { ok:true };
        }
        return { ok:false };
      }

      // 🔥 FIXED + CLEAN setSession()
      function setSession(user, role){
        try{
          localStorage.setItem('loggedInUser', user);
          localStorage.setItem('loggedInRole', role);
          sessionStorage.setItem('loggedInUser', user);
          sessionStorage.setItem('loggedInRole', role);
        }catch(e){
          console.warn('setSession storage error', e);
        }

        db.settings.put({
          key: 'session',
          value: { user, role, createdAt: new Date().toISOString() }
        }).catch(()=>{});

        console.log("Session Saved:", {
          user,
          role,
          localRole: localStorage.getItem('loggedInRole'),
          sessionRole: sessionStorage.getItem('loggedInRole')
        });
      }

      // LOGIN BUTTON
      loginBtn.addEventListener('click', async function(e){
        e.preventDefault();

        const username = usernameEl.value.trim();
        const password = passwordEl.value;
        const selectedRole = document.getElementById('role').value;

        if(!username || !password){
          alert("Enter username and password");
          return;
        }

        const verified = await verifyAgainstUsers(username, password);
        const legacy = await verifyAgainstLegacy(username, password);

        if(verified.ok || legacy.ok){
          setSession(username, selectedRole);

          if(selectedRole === 'distributor'){
            window.location.href = 'distributor.html';
          } else {
            window.location.href = 'invoice.html';
          }
        } else {
          alert("Invalid username or password");
        }
      });

      // ENTER to login
      [usernameEl,passwordEl].forEach(el =>
        el.addEventListener('keydown', e => { if(e.key === "Enter") loginBtn.click(); })
      );

      // ---------- GUEST MODE (all-access) ----------
      guestBtn.addEventListener('click', async ()=>{
        const guest = 'guest';
        const role = 'all-access';

        setSession(guest, role);

        window.location.href = 'invoice.html';
      });

      // ---------- RESET TO DEFAULT ----------
      forgotBtn.addEventListener('click', async ()=>{
        if(!confirm("Reset credentials to admin/admin123?")) return;
        await db.settings.put({ key:'auth', value:{ username:'admin', password:'admin123' } });
        alert("Credentials reset");
      });

      // ---------- OPEN DB IMPORT ----------
      openDbBtn.addEventListener('click', ()=> loginFileInput.click());

    })();
  </script>

</body>
</html>
